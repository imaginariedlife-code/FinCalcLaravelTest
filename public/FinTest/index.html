<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#3B82F6">
    <title>Финансовый калькулятор</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --tg-theme-bg-color: #ffffff;
            --tg-theme-text-color: #000000;
            --tg-theme-hint-color: #999999;
            --tg-theme-link-color: #3B82F6;
            --tg-theme-button-color: #3B82F6;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: #f0f0f0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            overscroll-behavior: none;
            overflow-x: hidden;
            touch-action: pan-y;
        }

        .container {
            max-width: 640px;
            margin: 0 auto;
            padding: 1rem;
            padding-bottom: calc(5rem + env(safe-area-inset-bottom));
        }

        /* Progress Bar */
        .progress-bar {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding: 0.5rem 0;
        }

        .progress-step {
            flex: 1;
            height: 4px;
            background: #e2e8f0;
            border-radius: 2px;
            position: relative;
            overflow: hidden;
        }

        .progress-step.active,
        .progress-step.completed {
            background: var(--tg-theme-button-color);
        }

        .progress-step-label {
            position: absolute;
            top: -1.5rem;
            left: 0;
            font-size: 0.7rem;
            color: var(--tg-theme-hint-color);
            white-space: nowrap;
        }

        .progress-step.active .progress-step-label {
            color: var(--tg-theme-button-color);
            font-weight: 600;
        }

        /* Steps */
        .step {
            display: none;
        }

        .step.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .step-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--tg-theme-text-color);
        }

        .step-description {
            font-size: 0.9rem;
            color: var(--tg-theme-hint-color);
            margin-bottom: 1.5rem;
        }

        .card {
            background: var(--tg-theme-secondary-bg-color);
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        .form-label {
            display: block;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--tg-theme-text-color);
            margin-bottom: 0.75rem;
        }

        .form-input {
            width: 100%;
            padding: 0.875rem;
            font-size: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            color: var(--tg-theme-text-color);
            transition: all 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--tg-theme-button-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-input::placeholder {
            color: #cbd5e1;
            opacity: 1;
        }

        .input-suffix {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--tg-theme-hint-color);
            font-size: 0.9rem;
            pointer-events: none;
        }

        .input-group {
            position: relative;
        }

        /* Slider Styles */
        .slider-container {
            padding: 0.5rem 0;
            touch-action: none;
        }

        .slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #e2e8f0;
            outline: none;
            margin-bottom: 1rem;
            touch-action: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--tg-theme-button-color);
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease;
        }

        .slider::-webkit-slider-thumb:active {
            transform: scale(1.2);
        }

        .slider::-moz-range-thumb {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--tg-theme-button-color);
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            border: none;
            transition: transform 0.2s ease;
        }

        .slider::-moz-range-thumb:active {
            transform: scale(1.2);
        }

        .slider-value {
            text-align: center;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--tg-theme-button-color);
            padding: 0.75rem;
            background: white;
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }

        .slider-hint {
            text-align: center;
            font-size: 0.75rem;
            color: var(--tg-theme-hint-color);
            margin-top: 0.25rem;
        }

        /* Savings Display */
        .savings-card {
            background: linear-gradient(135deg, #DBEAFE 0%, white 100%);
            border: 2px solid #93C5FD;
            border-radius: 12px;
            padding: 1.25rem;
            margin-top: 1.5rem;
        }

        .savings-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: #1e40af;
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .savings-value {
            font-size: 2rem;
            font-weight: 700;
            color: #1e40af;
            text-align: center;
        }

        .savings-value.negative {
            color: #dc2626;
        }

        /* Asset Categories */
        .asset-categories {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }

        .asset-category {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .asset-category:active {
            transform: scale(0.98);
        }

        .asset-category.selected {
            border-color: var(--tg-theme-button-color);
            background: #eff6ff;
        }

        .asset-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .asset-category-name {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--tg-theme-text-color);
        }

        /* Asset List */
        .asset-list {
            margin-top: 1rem;
        }

        .asset-item {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .asset-item-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex: 1;
        }

        .asset-item-icon {
            font-size: 1.5rem;
        }

        .asset-item-details {
            flex: 1;
        }

        .asset-item-name {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--tg-theme-text-color);
        }

        .asset-item-category {
            font-size: 0.75rem;
            color: var(--tg-theme-hint-color);
        }

        .asset-item-amount {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--tg-theme-button-color);
            margin-right: 0.5rem;
        }

        .btn-delete {
            background: transparent;
            border: none;
            color: #dc2626;
            font-size: 1.5rem;
            padding: 0.25rem;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        .btn-delete:active {
            opacity: 1;
        }

        .empty-state {
            text-align: center;
            padding: 2rem 1rem;
            color: var(--tg-theme-hint-color);
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: 0.5rem;
            opacity: 0.5;
        }

        .total-card {
            background: linear-gradient(135deg, #D1FAE5 0%, white 100%);
            border: 2px solid #6EE7B7;
            border-radius: 12px;
            padding: 1.25rem;
            margin-top: 1rem;
        }

        .total-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: #065f46;
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .total-value {
            font-size: 2rem;
            font-weight: 700;
            color: #065f46;
            text-align: center;
        }

        /* Buttons */
        .button-group {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--tg-theme-bg-color);
            padding: 1rem;
            padding-bottom: calc(1rem + env(safe-area-inset-bottom));
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 0.75rem;
        }

        .btn {
            flex: 1;
            padding: 1rem;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 48px;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
        }

        .btn-primary:disabled {
            background: #cbd5e1;
            color: #64748b;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .btn-secondary {
            background: var(--tg-theme-secondary-bg-color);
            color: var(--tg-theme-text-color);
            border: 2px solid #e2e8f0;
        }

        .btn-add {
            width: 100%;
            background: white;
            color: var(--tg-theme-button-color);
            border: 2px dashed var(--tg-theme-button-color);
            margin-top: 0.5rem;
        }

        /* Hidden */
        .hidden {
            display: none !important;
        }

        /* Utility */
        .mt-2 {
            margin-top: 1rem;
        }

        /* Risk Profiles */
        .risk-profiles {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .risk-profile {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .risk-profile:active {
            transform: scale(0.98);
        }

        .risk-profile.selected {
            border-color: var(--tg-theme-button-color);
            background: #eff6ff;
        }

        .risk-profile-icon {
            font-size: 2rem;
            flex-shrink: 0;
        }

        .risk-profile-content {
            flex: 1;
        }

        .risk-profile-name {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--tg-theme-text-color);
            margin-bottom: 0.25rem;
        }

        .risk-profile-desc {
            font-size: 0.8rem;
            color: var(--tg-theme-hint-color);
        }

        /* Chart Legend */
        .chart-legend {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
        }

        .legend-label {
            font-size: 0.85rem;
            color: var(--tg-theme-text-color);
        }

        /* Chart */
        .chart-container {
            width: 100%;
            height: 250px;
            margin-bottom: 1.5rem;
            position: relative;
        }

        .chart-container svg {
            width: 100%;
            height: 100%;
        }

        /* Toggle */
        .inflation-toggle {
            display: flex;
            justify-content: center;
            margin-top: 1rem;
        }

        .toggle-label {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
        }

        .toggle-input {
            display: none;
        }

        .toggle-slider {
            width: 44px;
            height: 24px;
            background: #e2e8f0;
            border-radius: 12px;
            position: relative;
            transition: background 0.3s;
        }

        .toggle-slider::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
        }

        .toggle-input:checked + .toggle-slider {
            background: var(--tg-theme-button-color);
        }

        .toggle-input:checked + .toggle-slider::after {
            transform: translateX(20px);
        }

        .toggle-text {
            font-size: 0.9rem;
            color: var(--tg-theme-text-color);
        }

        /* Table */
        .table-container {
            overflow-x: auto;
        }

        .projection-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .projection-table th {
            background: #f8fafc;
            padding: 0.75rem 0.5rem;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #e2e8f0;
            white-space: nowrap;
        }

        .projection-table td {
            padding: 0.75rem 0.5rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .projection-table tr:last-child td {
            border-bottom: none;
        }

        .projection-table .year-col {
            font-weight: 600;
        }

        .projection-table .pessimistic-col {
            color: #ef4444;
        }

        .projection-table .base-col {
            color: #3b82f6;
        }

        .projection-table .optimistic-col {
            color: #10b981;
        }

        /* Info Button */
        .btn-info {
            padding: 0.5rem 0.75rem;
            font-size: 0.8rem;
            font-weight: 600;
            background: white;
            color: var(--tg-theme-button-color);
            border: 2px solid var(--tg-theme-button-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .btn-info:active {
            transform: scale(0.95);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--tg-theme-bg-color);
            border-radius: 12px;
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.25rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .modal-header h3 {
            font-size: 1.1rem;
            font-weight: 700;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--tg-theme-hint-color);
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-body {
            padding: 1.25rem;
        }

        .scenario-info-item {
            margin-bottom: 1.5rem;
        }

        .scenario-info-item:last-child {
            margin-bottom: 0;
        }

        .scenario-info-title {
            font-weight: 600;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .scenario-info-table {
            width: 100%;
            font-size: 0.85rem;
        }

        .scenario-info-table td {
            padding: 0.5rem 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .scenario-info-table td:first-child {
            color: var(--tg-theme-hint-color);
        }

        .scenario-info-table td:last-child {
            text-align: right;
            font-weight: 600;
        }

        /* Step 6: Regular Investments Styles */
        .profile-summary-card {
            background: linear-gradient(135deg, #EDE9FE 0%, white 100%);
            border: 2px solid #C4B5FD;
            margin-bottom: 1rem;
        }

        .profile-summary-header {
            font-size: 1rem;
            font-weight: 600;
            color: #5B21B6;
            margin-bottom: 1rem;
            text-align: center;
        }

        .profile-summary-content {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .profile-summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .profile-summary-label {
            font-size: 0.9rem;
            color: #6B21A8;
        }

        .profile-summary-value {
            font-size: 1rem;
            font-weight: 600;
            color: #5B21B6;
        }

        .profile-summary-hint {
            font-size: 0.85rem;
            color: #7C3AED;
            text-align: center;
            padding-top: 0.75rem;
            border-top: 1px solid #DDD6FE;
        }

        .allocation-recommended {
            font-size: 0.75rem;
            color: var(--tg-theme-hint-color);
            margin-top: 0.25rem;
            text-align: center;
        }

        .allocation-warning {
            font-size: 0.75rem;
            color: #EF4444;
            margin-top: 0.25rem;
            text-align: center;
            padding: 0.5rem;
            background: #FEE2E2;
            border-radius: 6px;
        }

        .allocation-item-disabled {
            opacity: 0.5;
        }

        .allocation-item-disabled .allocation-slider {
            cursor: not-allowed;
            background: #cbd5e1 !important;
        }

        .allocation-disabled-hint {
            font-size: 0.75rem;
            color: var(--tg-theme-hint-color);
            margin-top: 0.5rem;
            text-align: center;
            font-style: italic;
        }

        .allocation-returns {
            margin-top: 0.75rem;
            padding: 0.75rem;
            background: #F9FAFB;
            border-radius: 8px;
            font-size: 0.7rem;
        }

        .allocation-returns-title {
            font-weight: 600;
            color: var(--tg-theme-hint-color);
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .allocation-return-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.25rem 0;
        }

        .allocation-return-scenario {
            font-weight: 600;
        }

        .allocation-return-scenario.pessimistic {
            color: #EF4444;
        }

        .allocation-return-scenario.base {
            color: #3B82F6;
        }

        .allocation-return-scenario.optimistic {
            color: #10B981;
        }

        .allocation-return-formula {
            color: var(--tg-theme-hint-color);
            font-size: 0.65rem;
        }

        .savings-reminder {
            background: linear-gradient(135deg, #FEF3C7 0%, white 100%);
            border: 2px solid #FCD34D;
            border-radius: 12px;
            padding: 1.25rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .savings-reminder-icon {
            font-size: 2.5rem;
        }

        .savings-reminder-content {
            flex: 1;
        }

        .savings-reminder-label {
            font-size: 0.85rem;
            color: #92400E;
            margin-bottom: 0.25rem;
        }

        .savings-reminder-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #92400E;
        }

        .investment-amount-card {
            background: linear-gradient(135deg, #E0E7FF 0%, white 100%);
            border: 2px solid #A5B4FC;
            border-radius: 12px;
            padding: 1.25rem;
            margin-top: 1rem;
            text-align: center;
        }

        .investment-amount-label {
            font-size: 0.85rem;
            color: #3730A3;
            margin-bottom: 0.5rem;
        }

        .investment-amount-value {
            font-size: 2rem;
            font-weight: 700;
            color: #3730A3;
        }

        .investment-amount-hint {
            font-size: 0.75rem;
            color: #6366F1;
            margin-top: 0.5rem;
        }

        .asset-allocation {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 1rem;
        }

        .allocation-item {
            margin-bottom: 1.25rem;
        }

        .allocation-item:last-of-type {
            margin-bottom: 1rem;
        }

        .allocation-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .allocation-icon {
            font-size: 1.25rem;
        }

        .allocation-name {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--tg-theme-text-color);
            flex: 1;
        }

        .allocation-toggle-btn {
            background: none;
            border: none;
            font-size: 0.7rem;
            color: var(--tg-theme-link-color);
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            transition: opacity 0.2s;
        }

        .allocation-toggle-btn:active {
            opacity: 0.6;
        }

        .allocation-toggle-icon {
            font-size: 0.9rem;
            transition: transform 0.3s;
        }

        .allocation-toggle-icon.expanded {
            transform: rotate(180deg);
        }

        .allocation-slider-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .allocation-slider {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: #e2e8f0;
            outline: none;
            -webkit-appearance: none;
            touch-action: none;
        }

        .allocation-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--tg-theme-button-color);
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease;
        }

        .allocation-slider::-webkit-slider-thumb:active {
            transform: scale(1.2);
        }

        .allocation-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--tg-theme-button-color);
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            border: none;
            transition: transform 0.2s ease;
        }

        .allocation-slider::-moz-range-thumb:active {
            transform: scale(1.2);
        }

        .allocation-value {
            min-width: 50px;
            text-align: right;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--tg-theme-button-color);
        }

        .allocation-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0 0.5rem;
            border-top: 2px solid #e2e8f0;
            font-size: 1.1rem;
            font-weight: 700;
        }

        .allocation-total-value {
            color: var(--tg-theme-button-color);
        }

        .allocation-total-value.valid {
            color: #10b981;
        }

        .allocation-total-value.invalid {
            color: #ef4444;
        }

        .allocation-hint {
            text-align: center;
            font-size: 0.75rem;
            color: var(--tg-theme-hint-color);
            margin-top: 0.5rem;
        }

        .allocation-hint.error {
            color: #ef4444;
        }

        .allocation-hint.success {
            color: #10b981;
        }

        /* Step 7: Comparison Results Styles */
        .benefit-summary-card {
            background: linear-gradient(135deg, #D1FAE5 0%, white 100%);
            border: 2px solid #10B981;
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 1.5rem;
        }

        /* Reduce spacing in Step 7 */
        #step-7 {
            margin-top: -0.5rem;  /* Pull closer to progress bar */
        }

        #step-7 .step-title {
            margin-bottom: 0.25rem;
        }

        #step-7 .step-description {
            margin-bottom: 1rem;
        }

        .benefit-title {
            font-size: 1rem;
            font-weight: 600;
            color: #059669;
            margin-bottom: 0.75rem;
        }

        .benefit-amount {
            font-size: 1.1rem;
            font-weight: 700;
            color: #047857;
            margin: 0.5rem 0;
            line-height: 1.6;
        }

        .benefit-amount span {
            font-size: 1.25rem;
            color: #065F46;
        }

        .benefit-hint {
            font-size: 0.85rem;
            color: #059669;
            margin-top: 0.5rem;
        }

        .comparison-section {
            margin-bottom: 1.5rem;
        }

        .comparison-title {
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--tg-theme-text-color);
        }

        .comparison-description {
            font-size: 0.8rem;
            color: var(--tg-theme-hint-color);
            margin-bottom: 0.75rem;
        }

        .breakdown-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-bottom: 1rem;
            justify-content: center;
        }

        /* Scenario Switcher */
        .scenario-switcher {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .scenario-btn,
        .scenario-btn-breakdown {
            padding: 0.5rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            color: var(--tg-theme-text-color);
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .scenario-btn:active,
        .scenario-btn-breakdown:active {
            transform: scale(0.95);
        }

        .scenario-btn.active,
        .scenario-btn-breakdown.active {
            background: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border-color: var(--tg-theme-button-color);
        }

        /* Combined Legend with line styles */
        .combined-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1rem;
            justify-content: center;
        }

        .legend-line {
            width: 30px;
            height: 3px;
            background: currentColor;
        }

        .legend-line.solid {
            background: var(--tg-theme-button-color);
        }

        .legend-line.dashed {
            background: repeating-linear-gradient(
                to right,
                var(--tg-theme-hint-color) 0,
                var(--tg-theme-hint-color) 5px,
                transparent 5px,
                transparent 10px
            );
            height: 2px;
            margin-top: 0.5px;
        }

        /* Asset type table */
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .asset-type-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .asset-type-table th {
            background: #f8fafc;
            padding: 0.75rem 0.5rem;
            text-align: right;
            font-weight: 600;
            color: var(--tg-theme-text-color);
            border-bottom: 2px solid #e2e8f0;
        }

        .asset-type-table th:first-child {
            text-align: left;
        }

        .asset-type-table td {
            padding: 0.5rem;
            text-align: right;
            border-top: 1px solid #e2e8f0;
            color: var(--tg-theme-text-color);
        }

        .asset-type-table td:first-child {
            text-align: left;
        }

        .asset-type-table tbody tr:hover {
            background: #f8fafc;
        }

        .asset-type-table th.subheader {
            font-size: 0.75rem;
            font-weight: 500;
            padding: 0.5rem 0.25rem;
            border-bottom: 2px solid #e2e8f0;
        }

        .asset-type-table td.contribution-column {
            font-size: 0.8rem;
            padding: 0.5rem 0.25rem;
            color: #64748b;
        }

        .asset-type-table td.return-column {
            font-size: 0.8rem;
            padding: 0.5rem 0.25rem;
        }

        .return-cell {
            font-weight: 500;
        }

        .return-cell.positive {
            color: #10b981;
        }

        .return-cell.negative {
            color: #ef4444;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Progress Bar -->
        <div class="progress-bar">
            <div class="progress-step active" id="progress-1">
                <span class="progress-step-label">1</span>
            </div>
            <div class="progress-step" id="progress-2">
                <span class="progress-step-label">2</span>
            </div>
            <div class="progress-step" id="progress-3">
                <span class="progress-step-label">3</span>
            </div>
            <div class="progress-step" id="progress-4">
                <span class="progress-step-label">4</span>
            </div>
            <div class="progress-step" id="progress-5">
                <span class="progress-step-label">5</span>
            </div>
            <div class="progress-step" id="progress-6">
                <span class="progress-step-label">6</span>
            </div>
            <div class="progress-step" id="progress-7">
                <span class="progress-step-label">7</span>
            </div>
        </div>

        <!-- Step 1: Profile -->
        <div class="step active" id="step-1">
            <h2 class="step-title">Расскажите о себе</h2>
            <p class="step-description">Эти данные помогут рассчитать ваш финансовый план</p>

            <div class="card">
                <div class="form-group">
                    <label class="form-label">Ваш возраст</label>
                    <div class="input-group">
                        <input type="text" class="form-input" id="age" placeholder="30" inputmode="numeric">
                        <span class="input-suffix">лет</span>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Ежемесячный доход</label>
                    <div class="slider-container">
                        <div class="slider-value" id="incomeValue">100 000 ₽</div>
                        <input type="range" class="slider" id="incomeSlider" min="0" max="500000" step="5000" value="100000">
                        <div class="slider-hint">0 ₽ — 500 000 ₽</div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Ежемесячные расходы</label>
                    <div class="slider-container">
                        <div class="slider-value" id="expensesValue">70 000 ₽</div>
                        <input type="range" class="slider" id="expensesSlider" min="0" max="500000" step="5000" value="70000">
                        <div class="slider-hint">0 ₽ — 500 000 ₽</div>
                    </div>
                </div>
            </div>

            <div class="savings-card">
                <div class="savings-label">Ежемесячные сбережения</div>
                <div class="savings-value" id="savingsValue">30 000 ₽</div>
            </div>
        </div>

        <!-- Step 2: Assets -->
        <div class="step" id="step-2">
            <h2 class="step-title">Ваши активы</h2>
            <p class="step-description">Укажите текущие накопления и инвестиции</p>

            <div class="card">
                <label class="form-label">Выберите категорию актива</label>
                <div class="asset-categories">
                    <div class="asset-category" data-type="stocks">
                        <div class="asset-icon">📈</div>
                        <div class="asset-category-name">Фонды акций</div>
                    </div>
                    <div class="asset-category" data-type="bonds">
                        <div class="asset-icon">📄</div>
                        <div class="asset-category-name">Фонды облигаций</div>
                    </div>
                    <div class="asset-category" data-type="cash">
                        <div class="asset-icon">💰</div>
                        <div class="asset-category-name">Депозиты</div>
                    </div>
                    <div class="asset-category" data-type="realty">
                        <div class="asset-icon">🏠</div>
                        <div class="asset-category-name">Недвижимость</div>
                    </div>
                </div>

                <div class="form-group" style="margin-top: 1.5rem;">
                    <label class="form-label">Сумма</label>
                    <div class="input-group">
                        <input type="text" class="form-input" id="assetAmount" placeholder="100 000" inputmode="numeric">
                        <span class="input-suffix">₽</span>
                    </div>
                </div>

                <button class="btn btn-add" id="btnAddAsset" disabled>
                    + Добавить актив
                </button>
            </div>

            <div class="total-card hidden" id="totalCard">
                <div class="total-label">Общая стоимость активов</div>
                <div class="total-value" id="totalValue">0 ₽</div>
            </div>

            <div class="asset-list" id="assetList"></div>
        </div>

        <!-- Step 3: Liabilities -->
        <div class="step" id="step-3">
            <h2 class="step-title">Обязательства</h2>
            <p class="step-description">Кредиты, ипотека и другие долговые обязательства</p>

            <div class="card">
                <div class="form-group">
                    <label class="form-label">Название обязательства</label>
                    <input type="text" class="form-input" id="liabilityName" placeholder="Например: Ипотека">
                </div>

                <div class="form-group">
                    <label class="form-label">Остаток долга</label>
                    <div class="input-group">
                        <input type="text" class="form-input" id="liabilityBalance" placeholder="2 000 000" inputmode="numeric">
                        <span class="input-suffix">₽</span>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Процентная ставка</label>
                    <div class="input-group">
                        <input type="text" class="form-input" id="liabilityRate" placeholder="10" inputmode="decimal">
                        <span class="input-suffix">%</span>
                    </div>
                    <div style="font-size: 0.75rem; color: var(--tg-theme-hint-color); margin-top: 0.5rem;">
                        Введите ставку или платеж - второе посчитается автоматически
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Срок кредита (остаток)</label>
                    <div class="input-group">
                        <input type="text" class="form-input" id="liabilityTerm" placeholder="120" inputmode="numeric">
                        <span class="input-suffix">мес</span>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Ежемесячный платеж</label>
                    <div class="input-group">
                        <input type="text" class="form-input" id="liabilityPayment" placeholder="0" inputmode="numeric">
                        <span class="input-suffix">₽</span>
                    </div>
                    <div style="font-size: 0.75rem; color: var(--tg-theme-hint-color); margin-top: 0.5rem;">
                        Введите платеж или ставку - второе посчитается автоматически
                    </div>
                </div>

                <button class="btn btn-add" id="btnAddLiability" disabled>
                    + Добавить обязательство
                </button>
            </div>

            <div class="total-card hidden" id="totalLiabilitiesCard" style="background: linear-gradient(135deg, #FEE2E2 0%, white 100%); border-color: #FCA5A5;">
                <div class="total-label" style="color: #991b1b;">Общая сумма долга</div>
                <div class="total-value" id="totalLiabilitiesValue" style="color: #991b1b;">0 ₽</div>
            </div>

            <div class="asset-list" id="liabilitiesList"></div>

            <div class="card mt-2">
                <p style="font-size: 0.85rem; color: var(--tg-theme-hint-color); text-align: center;">
                    Если у вас нет обязательств, можете пропустить этот шаг
                </p>
            </div>
        </div>

        <!-- Step 4: Planning Horizon & Risk Profile -->
        <div class="step" id="step-4">
            <h2 class="step-title">Горизонт планирования</h2>
            <p class="step-description">На какой срок вы планируете инвестировать</p>

            <div class="card">
                <div class="form-group">
                    <label class="form-label">Горизонт инвестирования</label>
                    <div class="slider-container">
                        <div class="slider-value" id="horizonValue">5 лет</div>
                        <input type="range" class="slider" id="horizonSlider" min="3" max="10" step="1" value="5">
                        <div class="slider-hint">3 года — 10 лет</div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Риск-профиль</label>
                    <div class="risk-profiles">
                        <div class="risk-profile" data-risk="conservative">
                            <div class="risk-profile-icon">🛡️</div>
                            <div class="risk-profile-content">
                                <div class="risk-profile-name">Консервативный</div>
                                <div class="risk-profile-desc">Сплю спокойно, минимум рисков</div>
                            </div>
                        </div>
                        <div class="risk-profile" data-risk="moderate">
                            <div class="risk-profile-icon">⚖️</div>
                            <div class="risk-profile-content">
                                <div class="risk-profile-name">Умеренный</div>
                                <div class="risk-profile-desc">Баланс риска и доходности</div>
                            </div>
                        </div>
                        <div class="risk-profile" data-risk="aggressive">
                            <div class="risk-profile-icon">🚀</div>
                            <div class="risk-profile-content">
                                <div class="risk-profile-name">Агрессивный</div>
                                <div class="risk-profile-desc">Живу с волатильностью</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Ожидаемая инфляция</label>
                    <div class="input-group">
                        <input type="text" class="form-input" id="inflationRate" placeholder="11" inputmode="decimal">
                        <span class="input-suffix">%</span>
                    </div>
                    <div style="font-size: 0.75rem; color: var(--tg-theme-hint-color); margin-top: 0.5rem;">
                        Если не знаете — предлагаем заложить 11%
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 5: Results -->
        <div class="step" id="step-5">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                <h2 class="step-title" style="margin-bottom: 0;">Ваш прогноз</h2>
                <button class="btn-info" id="btnScenarioInfo">ℹ️ Что заложено</button>
            </div>
            <p class="step-description">Рост капитала на горизонте <span id="resultsHorizon"></span></p>

            <div class="card">
                <div class="chart-legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ef4444;"></div>
                        <div class="legend-label">Пессимистичный</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #3b82f6;"></div>
                        <div class="legend-label">Базовый</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #10b981;"></div>
                        <div class="legend-label">Оптимистичный</div>
                    </div>
                </div>

                <div class="chart-container" id="chartContainer">
                    <!-- Chart will be rendered here -->
                </div>

                <div class="inflation-toggle">
                    <label class="toggle-label">
                        <input type="checkbox" id="inflationToggle" class="toggle-input">
                        <span class="toggle-slider"></span>
                        <span class="toggle-text">Учитывать инфляцию</span>
                    </label>
                </div>
            </div>

            <div class="card mt-2">
                <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem;">Детализация по годам</h3>
                <div class="table-container" id="tableContainer">
                    <!-- Table will be rendered here -->
                </div>
            </div>

            <div class="card mt-2">
                <p style="font-size: 0.85rem; color: var(--tg-theme-hint-color); text-align: center;">
                    📊 Сценарии — модель с упрощениями. Фактические доходности зависят от рынка и продукта.
                </p>
            </div>
        </div>

        <!-- Step 6: Regular Investments -->
        <div class="step" id="step-6">
            <h2 class="step-title">Регулярные инвестиции</h2>
            <p class="step-description">А теперь давайте представим, что вы будете регулярно откладывать разницу между доходами и расходами</p>

            <div class="card profile-summary-card">
                <div class="profile-summary-header">📊 Ваш профиль</div>
                <div class="profile-summary-content">
                    <div class="profile-summary-item">
                        <span class="profile-summary-label">Горизонт:</span>
                        <span class="profile-summary-value" id="profileHorizon">5 лет</span>
                    </div>
                    <div class="profile-summary-item">
                        <span class="profile-summary-label">Риск-профиль:</span>
                        <span class="profile-summary-value" id="profileRisk">⚖️ Умеренный</span>
                    </div>
                </div>
                <div class="profile-summary-hint">
                    На основе этих параметров мы рекомендуем следующее распределение активов:
                </div>
            </div>

            <div class="card">
                <div class="savings-reminder">
                    <div class="savings-reminder-icon">💰</div>
                    <div class="savings-reminder-content">
                        <div class="savings-reminder-label">Ваши ежемесячные сбережения</div>
                        <div class="savings-reminder-value" id="monthlySavingsReminder">0 ₽</div>
                    </div>
                </div>

                <div class="form-group" style="margin-top: 1.5rem;">
                    <label class="form-label">Какую часть сбережений будете инвестировать?</label>
                    <div class="slider-container">
                        <div class="slider-value" id="investmentPercentValue">100%</div>
                        <input type="range" class="slider" id="investmentPercentSlider" min="0" max="100" step="10" value="100">
                        <div class="slider-hint">0% — 100%</div>
                    </div>
                </div>

                <div class="investment-amount-card">
                    <div class="investment-amount-label">Ежемесячные инвестиции</div>
                    <div class="investment-amount-value" id="monthlyInvestmentAmount">0 ₽</div>
                    <div class="investment-amount-hint">= <span id="annualInvestmentAmount">0 ₽</span> в год</div>
                </div>

                <div class="form-group" style="margin-top: 1.5rem;">
                    <label class="form-label">В какие активы будете инвестировать?</label>
                    <div class="asset-allocation">
                        <div class="allocation-item">
                            <div class="allocation-header">
                                <span class="allocation-icon">📈</span>
                                <span class="allocation-name">Фонды акций</span>
                                <button class="allocation-toggle-btn" onclick="toggleAssetReturns('stocks')">
                                    <span class="allocation-toggle-icon" id="stocksToggleIcon">▼</span>
                                    <span>доходность</span>
                                </button>
                            </div>
                            <div class="allocation-slider-container">
                                <input type="range" class="allocation-slider" id="stocksAllocation" min="0" max="100" step="5" value="0">
                                <span class="allocation-value" id="stocksAllocationValue">0%</span>
                            </div>
                            <div class="allocation-recommended" id="stocksRecommended">рекомендовано 0%</div>
                            <div class="allocation-warning hidden" id="stocksWarning"></div>
                            <div class="allocation-returns hidden" id="stocksReturns"></div>
                        </div>

                        <div class="allocation-item">
                            <div class="allocation-header">
                                <span class="allocation-icon">📄</span>
                                <span class="allocation-name">Фонды облигаций</span>
                                <button class="allocation-toggle-btn" onclick="toggleAssetReturns('bonds')">
                                    <span class="allocation-toggle-icon" id="bondsToggleIcon">▼</span>
                                    <span>доходность</span>
                                </button>
                            </div>
                            <div class="allocation-slider-container">
                                <input type="range" class="allocation-slider" id="bondsAllocation" min="0" max="100" step="5" value="0">
                                <span class="allocation-value" id="bondsAllocationValue">0%</span>
                            </div>
                            <div class="allocation-recommended" id="bondsRecommended">рекомендовано 0%</div>
                            <div class="allocation-warning hidden" id="bondsWarning"></div>
                            <div class="allocation-returns hidden" id="bondsReturns"></div>
                        </div>

                        <div class="allocation-item">
                            <div class="allocation-header">
                                <span class="allocation-icon">💰</span>
                                <span class="allocation-name">Депозиты</span>
                                <button class="allocation-toggle-btn" onclick="toggleAssetReturns('cash')">
                                    <span class="allocation-toggle-icon" id="cashToggleIcon">▼</span>
                                    <span>доходность</span>
                                </button>
                            </div>
                            <div class="allocation-slider-container">
                                <input type="range" class="allocation-slider" id="cashAllocation" min="0" max="100" step="5" value="0">
                                <span class="allocation-value" id="cashAllocationValue">0%</span>
                            </div>
                            <div class="allocation-recommended" id="cashRecommended">рекомендовано 0%</div>
                            <div class="allocation-warning hidden" id="cashWarning"></div>
                            <div class="allocation-returns hidden" id="cashReturns"></div>
                        </div>

                        <div class="allocation-item allocation-item-disabled">
                            <div class="allocation-header">
                                <span class="allocation-icon">🏠</span>
                                <span class="allocation-name">Недвижимость</span>
                            </div>
                            <div class="allocation-slider-container">
                                <input type="range" class="allocation-slider" id="realtyAllocation" min="0" max="0" step="5" value="0" disabled>
                                <span class="allocation-value" id="realtyAllocationValue">0%</span>
                            </div>
                            <div class="allocation-disabled-hint">
                                💡 Регулярно и по чуть-чуть инвестировать в недвижимость не выйдет
                            </div>
                        </div>

                        <div class="allocation-total">
                            <span>Итого:</span>
                            <span id="totalAllocation" class="allocation-total-value">0%</span>
                        </div>
                        <div class="allocation-hint" id="allocationHint">Распределите 100% по активам</div>
                    </div>
                </div>
            </div>

            <div class="card mt-2">
                <p style="font-size: 0.85rem; color: var(--tg-theme-hint-color); text-align: center;">
                    💡 Регулярные инвестиции позволяют усреднить цену покупки и снизить влияние волатильности рынка
                </p>
            </div>
        </div>

        <!-- Step 7: Comparison Results -->
        <div class="step" id="step-7">
        <h2 class="step-title">Ваша выгода</h2>
        <p class="step-description">Результаты регулярных инвестиций</p>

        <!-- Benefit Summary Card -->
        <div class="benefit-summary-card">
            <div class="benefit-title">💰 Регулярно инвестируя вы получите</div>
            <div class="benefit-amount">
                От <span id="benefitMin">+0 ₽</span> до <span id="benefitMax">+0 ₽</span>
            </div>
            <div class="benefit-hint">За <span id="benefitHorizon">5</span> лет</div>
        </div>

        <!-- Combined Chart: Scenario Comparison -->
        <div class="comparison-section">
            <h3 class="comparison-title">График 1: Сравнение сценариев</h3>
            <p class="comparison-description">Две линии на одном графике - переключайте сценарии</p>

            <!-- Scenario Switcher -->
            <div class="scenario-switcher">
                <button class="scenario-btn active" data-scenario="base">
                    Базовый
                </button>
                <button class="scenario-btn" data-scenario="pessimistic">
                    Пессимистичный
                </button>
                <button class="scenario-btn" data-scenario="optimistic">
                    Оптимистичный
                </button>
            </div>

            <div class="card">
                <div class="combined-legend">
                    <div class="legend-item">
                        <div class="legend-line solid"></div>
                        <div class="legend-label">С регулярными инвестициями</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-line dashed"></div>
                        <div class="legend-label">Без регулярных инвестиций</div>
                    </div>
                </div>
                <div class="chart-container" id="chartCombined">
                    <!-- Combined chart will be rendered here -->
                </div>
            </div>
        </div>

        <!-- Breakdown Chart: Capital Composition -->
        <div class="comparison-section">
            <h3 class="comparison-title">График 2: Из чего состоит ваш капитал</h3>
            <p class="comparison-description">Декомпозиция по компонентам - переключайте сценарии</p>

            <!-- Scenario Switcher for Breakdown -->
            <div class="scenario-switcher">
                <button class="scenario-btn-breakdown active" data-scenario="base">
                    Базовый
                </button>
                <button class="scenario-btn-breakdown" data-scenario="pessimistic">
                    Пессимистичный
                </button>
                <button class="scenario-btn-breakdown" data-scenario="optimistic">
                    Оптимистичный
                </button>
            </div>

            <div class="card">
                <div class="breakdown-legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #10b981;"></div>
                        <div class="legend-label">Базовые активы</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #3b82f6;"></div>
                        <div class="legend-label">Пополнения</div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #f59e0b;"></div>
                        <div class="legend-label">Доход от инвестиций</div>
                    </div>
                </div>
                <div class="chart-container" id="chartBreakdown">
                    <!-- Stacked bar chart will be rendered here -->
                </div>
            </div>

            <div class="card mt-2">
                <h4 style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem;">Детализация по типам активов</h4>
                <div class="table-container" id="assetTypeTableContainer">
                    <!-- Table will be rendered here -->
                </div>
            </div>
        </div>
        </div>
    </div>

    <!-- Navigation Buttons -->
    <div class="button-group">
        <button class="btn btn-secondary hidden" id="btnPrev">← Назад</button>
        <button class="btn btn-primary" id="btnNext">Далее →</button>
    </div>

    <!-- Scenario Info Modal -->
    <div class="modal" id="scenarioModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Что заложено в сценарии</h3>
                <button class="modal-close" id="modalClose">×</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Content will be rendered here -->
            </div>
        </div>
    </div>

    <script>
        // Telegram WebApp initialization
        let tg = window.Telegram?.WebApp;
        if (tg) {
            tg.ready();
            tg.expand();

            if (tg.themeParams) {
                document.documentElement.style.setProperty('--tg-theme-bg-color', tg.themeParams.bg_color || '#ffffff');
                document.documentElement.style.setProperty('--tg-theme-text-color', tg.themeParams.text_color || '#000000');
                document.documentElement.style.setProperty('--tg-theme-hint-color', tg.themeParams.hint_color || '#999999');
                document.documentElement.style.setProperty('--tg-theme-link-color', tg.themeParams.link_color || '#3B82F6');
                document.documentElement.style.setProperty('--tg-theme-button-color', tg.themeParams.button_color || '#3B82F6');
                document.documentElement.style.setProperty('--tg-theme-button-text-color', tg.themeParams.button_text_color || '#ffffff');
                document.documentElement.style.setProperty('--tg-theme-secondary-bg-color', tg.themeParams.secondary_bg_color || '#f0f0f0');
            }
        }

        // App State
        const appState = {
            currentStep: 1,
            profile: {
                age: null,
                monthlyIncome: 100000,
                monthlyExpenses: 70000
            },
            assets: [],
            selectedAssetType: null,
            liabilities: [],
            planning: {
                horizon: 5,
                riskProfile: null,
                inflation: 11
            },
            regularInvestments: {
                investmentPercent: 100,
                allocation: {
                    stocks: 0,
                    bonds: 0,
                    cash: 0,
                    realty: 0
                }
            }
        };

        const assetInfo = {
            stocks: { name: 'Фонды акций', icon: '📈' },
            bonds: { name: 'Фонды облигаций', icon: '📄' },
            cash: { name: 'Депозиты', icon: '💰' },
            realty: { name: 'Недвижимость', icon: '🏠' }
        };

        // Recommended allocations based on horizon and risk profile (from PDF, section 4)
        const RECOMMENDED_ALLOCATIONS = {
            '3-4': {
                conservative: { stocks: 0, bonds: 80, cash: 20, realty: 0 },
                moderate: { stocks: 10, bonds: 70, cash: 20, realty: 0 },
                aggressive: { stocks: 70, bonds: 30, cash: 0, realty: 0 }
            },
            '5-9': {
                conservative: { stocks: 10, bonds: 80, cash: 10, realty: 0 },
                moderate: { stocks: 30, bonds: 60, cash: 10, realty: 0 },
                aggressive: { stocks: 80, bonds: 20, cash: 0, realty: 0 }
            },
            '10+': {
                conservative: { stocks: 20, bonds: 70, cash: 10, realty: 0 },
                moderate: { stocks: 40, bonds: 50, cash: 10, realty: 0 },
                aggressive: { stocks: 90, bonds: 10, cash: 0, realty: 0 }
            }
        };

        const riskProfileInfo = {
            conservative: { name: 'Консервативный', icon: '🛡️' },
            moderate: { name: 'Умеренный', icon: '⚖️' },
            aggressive: { name: 'Агрессивный', icon: '🚀' }
        };

        // Expected returns deltas for each asset type and scenario (from PDF)
        const ASSET_RETURN_DELTAS = {
            stocks: {
                pessimistic: -4,
                base: 5,
                optimistic: 10
            },
            bonds: {
                pessimistic: -2,
                base: 1,
                optimistic: 5
            },
            cash: {
                pessimistic: -2,
                base: -1,
                optimistic: 0
            },
            realty: {
                pessimistic: 0,
                base: 1,
                optimistic: 2
            }
        };

        // DOM Elements
        const steps = document.querySelectorAll('.step');
        const progressSteps = document.querySelectorAll('.progress-step');
        const btnNext = document.getElementById('btnNext');
        const btnPrev = document.getElementById('btnPrev');

        // Step 1 elements
        const ageInput = document.getElementById('age');
        const incomeSlider = document.getElementById('incomeSlider');
        const expensesSlider = document.getElementById('expensesSlider');
        const incomeValue = document.getElementById('incomeValue');
        const expensesValue = document.getElementById('expensesValue');
        const savingsValue = document.getElementById('savingsValue');

        // Step 2 elements
        const assetCategories = document.querySelectorAll('.asset-category');
        const assetAmountInput = document.getElementById('assetAmount');
        const btnAddAsset = document.getElementById('btnAddAsset');
        const assetList = document.getElementById('assetList');
        const totalCard = document.getElementById('totalCard');
        const totalValue = document.getElementById('totalValue');

        // Step 3 elements
        const liabilityNameInput = document.getElementById('liabilityName');
        const liabilityBalanceInput = document.getElementById('liabilityBalance');
        const liabilityRateInput = document.getElementById('liabilityRate');
        const liabilityTermInput = document.getElementById('liabilityTerm');
        const liabilityPaymentInput = document.getElementById('liabilityPayment');
        const btnAddLiability = document.getElementById('btnAddLiability');
        const liabilitiesList = document.getElementById('liabilitiesList');
        const totalLiabilitiesCard = document.getElementById('totalLiabilitiesCard');
        const totalLiabilitiesValue = document.getElementById('totalLiabilitiesValue');

        // Step 4 elements
        const horizonSlider = document.getElementById('horizonSlider');
        const horizonValue = document.getElementById('horizonValue');
        const riskProfiles = document.querySelectorAll('.risk-profile');
        const inflationRateInput = document.getElementById('inflationRate');

        // Step 5 elements
        const chartContainer = document.getElementById('chartContainer');
        const tableContainer = document.getElementById('tableContainer');
        const inflationToggle = document.getElementById('inflationToggle');
        const resultsHorizon = document.getElementById('resultsHorizon');
        const btnScenarioInfo = document.getElementById('btnScenarioInfo');
        const scenarioModal = document.getElementById('scenarioModal');
        const modalClose = document.getElementById('modalClose');
        const modalBody = document.getElementById('modalBody');

        // Step 6 elements
        const profileHorizon = document.getElementById('profileHorizon');
        const profileRisk = document.getElementById('profileRisk');
        const monthlySavingsReminder = document.getElementById('monthlySavingsReminder');
        const investmentPercentSlider = document.getElementById('investmentPercentSlider');
        const investmentPercentValue = document.getElementById('investmentPercentValue');
        const monthlyInvestmentAmount = document.getElementById('monthlyInvestmentAmount');
        const annualInvestmentAmount = document.getElementById('annualInvestmentAmount');
        const stocksAllocation = document.getElementById('stocksAllocation');
        const bondsAllocation = document.getElementById('bondsAllocation');
        const cashAllocation = document.getElementById('cashAllocation');
        const realtyAllocation = document.getElementById('realtyAllocation');
        const stocksAllocationValue = document.getElementById('stocksAllocationValue');
        const bondsAllocationValue = document.getElementById('bondsAllocationValue');
        const cashAllocationValue = document.getElementById('cashAllocationValue');
        const realtyAllocationValue = document.getElementById('realtyAllocationValue');
        const stocksRecommended = document.getElementById('stocksRecommended');
        const bondsRecommended = document.getElementById('bondsRecommended');
        const cashRecommended = document.getElementById('cashRecommended');
        const stocksWarning = document.getElementById('stocksWarning');
        const bondsWarning = document.getElementById('bondsWarning');
        const cashWarning = document.getElementById('cashWarning');
        const totalAllocation = document.getElementById('totalAllocation');
        const allocationHint = document.getElementById('allocationHint');

        // Step 7 elements
        const benefitMin = document.getElementById('benefitMin');
        const benefitMax = document.getElementById('benefitMax');
        const benefitHorizon = document.getElementById('benefitHorizon');
        const chartWithout = document.getElementById('chartWithout');
        const chartWith = document.getElementById('chartWith');
        const chartBreakdown = document.getElementById('chartBreakdown');
        const chartCombined = document.getElementById('chartCombined');
        const scenarioBtns = document.querySelectorAll('.scenario-btn');
        const scenarioBtnsBreakdown = document.querySelectorAll('.scenario-btn-breakdown');

        // Format currency
        function formatCurrency(value) {
            return new Intl.NumberFormat('ru-RU', {
                style: 'currency',
                currency: 'RUB',
                maximumFractionDigits: 0
            }).format(value);
        }

        // Format number with spaces
        function formatNumberWithSpaces(value) {
            return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
        }

        // Parse number with spaces
        function parseNumberWithSpaces(value) {
            return value.replace(/\s/g, '');
        }

        // Format input as user types
        function formatInputOnType(input, allowDecimals = false) {
            let cursorPosition = input.selectionStart;
            let oldValue = input.value;
            let cleanValue = parseNumberWithSpaces(oldValue);

            // Only format if it's a valid number
            if (cleanValue && /^\d+\.?\d*$/.test(cleanValue)) {
                let formatted;
                if (allowDecimals && cleanValue.includes('.')) {
                    const parts = cleanValue.split('.');
                    formatted = formatNumberWithSpaces(parts[0]) + '.' + parts[1];
                } else {
                    formatted = formatNumberWithSpaces(cleanValue);
                }

                // Calculate new cursor position
                const spacesBefore = (oldValue.substring(0, cursorPosition).match(/\s/g) || []).length;
                const spacesAfter = (formatted.substring(0, cursorPosition).match(/\s/g) || []).length;
                const newPosition = cursorPosition + (spacesAfter - spacesBefore);

                input.value = formatted;
                input.setSelectionRange(newPosition, newPosition);
            }
        }

        // Update slider background
        function updateSliderBackground(slider) {
            const value = slider.value;
            const min = slider.min || 0;
            const max = slider.max || 100;
            const percentage = ((value - min) / (max - min)) * 100;
            slider.style.background = `linear-gradient(to right, var(--tg-theme-button-color) 0%, var(--tg-theme-button-color) ${percentage}%, #e2e8f0 ${percentage}%, #e2e8f0 100%)`;
        }

        // Update savings display
        function updateSavings() {
            const savings = appState.profile.monthlyIncome - appState.profile.monthlyExpenses;
            savingsValue.textContent = formatCurrency(savings);
            savingsValue.className = 'savings-value';
            if (savings < 0) {
                savingsValue.classList.add('negative');
            }

            // Update button state if on step 1
            if (appState.currentStep === 1) {
                btnNext.disabled = !validateStep1();
            }
        }

        // Validate Step 1
        function validateStep1() {
            const age = parseInt(parseNumberWithSpaces(ageInput.value));
            const isValid = age && age >= 18 && age <= 100 &&
                          appState.profile.monthlyExpenses <= appState.profile.monthlyIncome;

            if (isValid) {
                appState.profile.age = age;
            }

            return isValid;
        }

        // Validate Step 2
        function validateStep2() {
            return true; // Assets are optional
        }

        // Validate Step 3
        function validateStep3() {
            return true; // Liabilities are optional
        }

        // Validate Step 4
        function validateStep4() {
            const inflation = parseFloat(parseNumberWithSpaces(inflationRateInput.value));
            return appState.planning.riskProfile && inflation > 0;
        }

        // Validate Step 5
        function validateStep5() {
            return true; // Results page, always valid
        }

        // Validate Step 6
        function validateStep6() {
            const total = appState.regularInvestments.allocation.stocks +
                         appState.regularInvestments.allocation.bonds +
                         appState.regularInvestments.allocation.cash +
                         appState.regularInvestments.allocation.realty;
            return total === 100;
        }

        // Update horizon display
        function updateHorizon() {
            const years = parseInt(horizonSlider.value);
            appState.planning.horizon = years;

            let yearText = 'лет';
            if (years === 1) yearText = 'год';
            else if (years >= 2 && years <= 4) yearText = 'года';

            horizonValue.textContent = `${years} ${yearText}`;
        }

        // Returns for different scenarios (delta to inflation from PDF)
        const scenarioReturns = {
            pessimistic: { stocks: -4, bonds: -2, cash: -2 },
            base: { stocks: 5, bonds: 1, cash: -1 },
            optimistic: { stocks: 10, bonds: 5, cash: 0 }
        };

        // Helper: Calculate weighted return based on actual assets
        function calculateWeightedReturn(scenario, assets) {
            const totalAssets = assets.reduce((sum, a) => sum + a.amount, 0);
            if (totalAssets === 0) return 0;

            let weightedDelta = 0;
            assets.forEach(asset => {
                const weight = asset.amount / totalAssets;
                const assetType = asset.type; // 'stocks', 'bonds', 'cash', 'realty'
                const delta = ASSET_RETURN_DELTAS[assetType][scenario] || 0;
                weightedDelta += weight * delta;
            });

            return weightedDelta / 100;
        }

        // Calculate portfolio projection
        function calculateProjection(scenario) {
            const horizon = appState.planning.horizon;
            const inflation = appState.planning.inflation / 100;

            // Calculate initial capital from assets
            const totalAssets = appState.assets.reduce((sum, a) => sum + a.amount, 0);

            // Calculate weighted return based on actual assets
            const annualReturn = inflation + calculateWeightedReturn(scenario, appState.assets);

            const projectionData = [];
            let capital = totalAssets;

            for (let year = 0; year <= horizon; year++) {
                projectionData.push({
                    year: year,
                    capital: Math.round(capital)
                });

                if (year < horizon) {
                    // Compound interest: grow existing capital only
                    // Year N = Year (N-1) × (1 + rate)
                    capital *= (1 + annualReturn);
                }
            }

            return projectionData;
        }

        // Render chart with all scenarios
        function renderChart() {
            const useInflation = inflationToggle.checked;
            const inflation = appState.planning.inflation / 100;

            const scenarios = ['pessimistic', 'base', 'optimistic'];
            const scenarioData = {};
            const scenarioColors = {
                pessimistic: '#ef4444',
                base: '#3b82f6',
                optimistic: '#10b981'
            };

            // Calculate all scenarios
            scenarios.forEach(scenario => {
                scenarioData[scenario] = calculateProjection(scenario);
            });

            // Apply inflation adjustment if needed
            if (useInflation) {
                scenarios.forEach(scenario => {
                    scenarioData[scenario] = scenarioData[scenario].map(point => ({
                        ...point,
                        capital: Math.round(point.capital / Math.pow(1 + inflation, point.year))
                    }));
                });
            }

            const width = chartContainer.clientWidth;
            const height = 350;
            const padding = 40;

            // Find global min/max
            let allCapitals = [];
            scenarios.forEach(scenario => {
                allCapitals = allCapitals.concat(scenarioData[scenario].map(d => d.capital));
            });
            const maxCapital = Math.max(...allCapitals);
            const minCapital = Math.min(...allCapitals);

            const xScale = (year) => padding + (year / appState.planning.horizon) * (width - 2 * padding);
            const yScale = (capital) => height - padding - ((capital - minCapital) / (maxCapital - minCapital)) * (height - 2 * padding);

            // Generate paths for each scenario
            const paths = scenarios.map(scenario => {
                const data = scenarioData[scenario];
                let pathD = '';
                data.forEach((point, i) => {
                    const x = xScale(point.year);
                    const y = yScale(point.capital);
                    if (i === 0) {
                        pathD += `M ${x} ${y}`;
                    } else {
                        pathD += ` L ${x} ${y}`;
                    }
                });
                return { scenario, pathD, data, color: scenarioColors[scenario] };
            });

            // Format values for Y axis (shorter for mobile)
            const formatYAxisValue = (value) => {
                if (value >= 1000000) {
                    return (value / 1000000).toFixed(1) + 'M';
                } else if (value >= 1000) {
                    return (value / 1000).toFixed(0) + 'K';
                }
                return value.toFixed(0);
            };

            let svg = `
                <svg viewBox="0 0 ${width} ${height}" xmlns="http://www.w3.org/2000/svg">
                    <!-- Grid lines -->
                    ${[0, 0.5, 1].map(ratio => {
                        const y = height - padding - ratio * (height - 2 * padding);
                        const value = minCapital + ratio * (maxCapital - minCapital);
                        return `
                            <line x1="${padding}" y1="${y}" x2="${width - padding}" y2="${y}" stroke="#e2e8f0" stroke-width="1"/>
                            <text x="${padding - 5}" y="${y + 4}" text-anchor="end" font-size="10" fill="#999">${formatYAxisValue(value)}</text>
                        `;
                    }).join('')}

                    <!-- X axis labels -->
                    ${scenarioData.base.map(point => {
                        const x = xScale(point.year);
                        return `<text x="${x}" y="${height - padding + 20}" text-anchor="middle" font-size="10" fill="#999">${point.year}г</text>`;
                    }).join('')}

                    <!-- Lines for all scenarios -->
                    ${paths.map(({ scenario, pathD, color }) => `
                        <path d="${pathD}" fill="none" stroke="${color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" opacity="0.8"/>
                    `).join('')}

                    <!-- Points for all scenarios -->
                    ${paths.map(({ scenario, data, color }) => data.map(point => {
                        const x = xScale(point.year);
                        const y = yScale(point.capital);
                        return `<circle cx="${x}" cy="${y}" r="3" fill="${color}" opacity="0.8"/>`;
                    }).join('')).join('')}
                </svg>
            `;

            chartContainer.innerHTML = svg;

            // Render table
            renderTable(scenarioData, useInflation);
        }

        // Render projection table
        function renderTable(scenarioData, useInflation) {
            const html = `
                <table class="projection-table">
                    <thead>
                        <tr>
                            <th>Год</th>
                            <th class="pessimistic-col">Пессим.</th>
                            <th class="base-col">Базовый</th>
                            <th class="optimistic-col">Оптим.</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${scenarioData.base.map((point, index) => `
                            <tr>
                                <td class="year-col">${point.year}</td>
                                <td class="pessimistic-col">${formatCurrency(scenarioData.pessimistic[index].capital)}</td>
                                <td class="base-col">${formatCurrency(scenarioData.base[index].capital)}</td>
                                <td class="optimistic-col">${formatCurrency(scenarioData.optimistic[index].capital)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            tableContainer.innerHTML = html;
        }

        // Step 7: Calculate projection WITHOUT regular contributions (only existing assets grow)
        function calculateProjectionWithoutContributions(scenario) {
            const horizon = appState.planning.horizon;
            const inflation = appState.planning.inflation / 100;
            const totalAssets = appState.assets.reduce((sum, a) => sum + a.amount, 0);

            // Calculate weighted return based on actual assets
            const annualReturn = inflation + calculateWeightedReturn(scenario, appState.assets);

            const projectionData = [];
            let capital = totalAssets;

            for (let year = 0; year <= horizon; year++) {
                projectionData.push({
                    year: year,
                    capital: Math.round(capital)
                });

                if (year < horizon) {
                    // NO contributions, only apply return to existing capital
                    capital *= (1 + annualReturn);
                }
            }

            return projectionData;
        }

        // Step 7: Calculate projection WITH regular investments
        function calculateProjectionWithRegularInvestments(scenario) {
            const horizon = appState.planning.horizon;
            const inflation = appState.planning.inflation / 100;
            const totalAssets = appState.assets.reduce((sum, a) => sum + a.amount, 0);
            const monthlySavings = appState.profile.monthlyIncome - appState.profile.monthlyExpenses;
            const returns = ASSET_RETURN_DELTAS;

            // Calculate return for base assets (from actual assets)
            const baseAssetsReturn = inflation + calculateWeightedReturn(scenario, appState.assets);

            // Calculate return for contributions (from allocation in Step 6)
            const allocation = appState.regularInvestments.allocation;
            const contributionsDelta = (
                (allocation.stocks / 100) * returns.stocks[scenario] +
                (allocation.bonds / 100) * returns.bonds[scenario] +
                (allocation.cash / 100) * returns.cash[scenario]
            );
            const contributionsReturn = inflation + (contributionsDelta / 100);

            // Monthly investment amount
            const investmentPercent = appState.regularInvestments.investmentPercent / 100;
            const monthlyInvestment = monthlySavings * investmentPercent;

            const projectionData = [];
            let baseCapital = totalAssets;
            let contributionsCapital = 0;

            for (let year = 0; year <= horizon; year++) {
                const totalCapital = baseCapital + contributionsCapital;
                projectionData.push({
                    year: year,
                    capital: Math.round(totalCapital)
                });

                if (year < horizon) {
                    // Add annual contributions to contributions bucket
                    contributionsCapital += monthlyInvestment * 12;

                    // Apply different returns to each bucket
                    baseCapital *= (1 + baseAssetsReturn);
                    contributionsCapital *= (1 + contributionsReturn);
                }
            }

            return projectionData;
        }

        // Step 7: Calculate projection breakdown (base, contributions, gains)
        function calculateProjectionBreakdown(scenario) {
            scenario = scenario || 'base';
            const horizon = appState.planning.horizon;
            const inflation = appState.planning.inflation / 100;
            const initialAssets = appState.assets.reduce((sum, a) => sum + a.amount, 0);
            const monthlySavings = appState.profile.monthlyIncome - appState.profile.monthlyExpenses;
            const returns = ASSET_RETURN_DELTAS;

            // Calculate return for base assets (from actual assets)
            const baseAssetsReturn = inflation + calculateWeightedReturn(scenario, appState.assets);

            // Calculate return for contributions (from allocation in Step 6)
            const allocation = appState.regularInvestments.allocation;
            const contributionsDelta = (
                (allocation.stocks / 100) * returns.stocks[scenario] +
                (allocation.bonds / 100) * returns.bonds[scenario] +
                (allocation.cash / 100) * returns.cash[scenario]
            );
            const contributionsReturn = inflation + (contributionsDelta / 100);

            const investmentPercent = appState.regularInvestments.investmentPercent / 100;
            const monthlyInvestment = monthlySavings * investmentPercent;

            const breakdownData = [];
            let baseAssetsValue = initialAssets;
            let contributionsValue = 0;
            let rawContributionsSum = 0;

            for (let year = 0; year <= horizon; year++) {
                const total = baseAssetsValue + contributionsValue;

                // For stacked bar chart: show initial capital + raw contributions + all gains
                const investmentGains = total - initialAssets - rawContributionsSum;

                breakdownData.push({
                    year: year,
                    baseAssets: initialAssets,  // Constant - initial assets without growth
                    totalContributions: Math.round(rawContributionsSum),  // Cumulative contributions without growth
                    investmentGains: Math.max(0, Math.round(investmentGains)),  // All growth from both buckets
                    total: Math.round(total)
                });

                if (year < horizon) {
                    // Add annual contributions
                    const annualContribution = monthlyInvestment * 12;
                    contributionsValue += annualContribution;
                    rawContributionsSum += annualContribution;

                    // Apply different returns to each bucket
                    baseAssetsValue *= (1 + baseAssetsReturn);
                    contributionsValue *= (1 + contributionsReturn);
                }
            }

            return breakdownData;
        }

        // Step 7: Calculate breakdown by asset type with compound interest
        function calculateAssetTypeBreakdown(scenario) {
            scenario = scenario || 'base';
            const horizon = appState.planning.horizon;
            const inflation = appState.planning.inflation / 100;
            const monthlySavings = appState.profile.monthlyIncome - appState.profile.monthlyExpenses;
            const returns = ASSET_RETURN_DELTAS;
            const allocation = appState.regularInvestments.allocation;
            const investmentPercent = appState.regularInvestments.investmentPercent / 100;
            const monthlyInvestment = monthlySavings * investmentPercent;

            // Group initial assets by type
            const initialByType = { stocks: 0, bonds: 0, cash: 0, realty: 0 };
            appState.assets.forEach(asset => {
                initialByType[asset.type] = (initialByType[asset.type] || 0) + asset.amount;
            });

            // Initialize values for each type
            const assetValues = {
                stocks: initialByType.stocks,
                bonds: initialByType.bonds,
                cash: initialByType.cash,
                realty: initialByType.realty
            };

            // Track previous values for growth calculation
            let prevValues = {
                stocks: initialByType.stocks,
                bonds: initialByType.bonds,
                cash: initialByType.cash,
                realty: initialByType.realty
            };

            const breakdownData = [];

            for (let year = 0; year <= horizon; year++) {
                const total = assetValues.stocks + assetValues.bonds + assetValues.cash + assetValues.realty;
                const prevTotal = prevValues.stocks + prevValues.bonds + prevValues.cash + prevValues.realty;

                // Calculate contributions (what was added this year)
                const annualContribution = monthlyInvestment * 12;
                const stocksContributions = year === 0 ? 0 : annualContribution * (allocation.stocks / 100);
                const bondsContributions = year === 0 ? 0 : annualContribution * (allocation.bonds / 100);
                const cashContributions = year === 0 ? 0 : annualContribution * (allocation.cash / 100);
                const realtyContributions = year === 0 ? 0 : annualContribution * (allocation.realty / 100);
                const totalContributions = stocksContributions + bondsContributions + cashContributions + realtyContributions;

                // Calculate total growth (difference from previous year)
                const stocksGrowth = year === 0 ? 0 : assetValues.stocks - prevValues.stocks;
                const bondsGrowth = year === 0 ? 0 : assetValues.bonds - prevValues.bonds;
                const cashGrowth = year === 0 ? 0 : assetValues.cash - prevValues.cash;
                const realtyGrowth = year === 0 ? 0 : assetValues.realty - prevValues.realty;
                const totalGrowth = year === 0 ? 0 : total - prevTotal;

                // Calculate investment return (growth minus contributions)
                const stocksInvestmentReturn = stocksGrowth - stocksContributions;
                const bondsInvestmentReturn = bondsGrowth - bondsContributions;
                const cashInvestmentReturn = cashGrowth - cashContributions;
                const realtyInvestmentReturn = realtyGrowth - realtyContributions;
                const totalInvestmentReturn = totalGrowth - totalContributions;

                breakdownData.push({
                    year: year,
                    stocks: Math.round(assetValues.stocks),
                    bonds: Math.round(assetValues.bonds),
                    cash: Math.round(assetValues.cash),
                    realty: Math.round(assetValues.realty),
                    total: Math.round(total),
                    stocksContributions: Math.round(stocksContributions),
                    bondsContributions: Math.round(bondsContributions),
                    cashContributions: Math.round(cashContributions),
                    realtyContributions: Math.round(realtyContributions),
                    totalContributions: Math.round(totalContributions),
                    stocksInvestmentReturn: Math.round(stocksInvestmentReturn),
                    bondsInvestmentReturn: Math.round(bondsInvestmentReturn),
                    cashInvestmentReturn: Math.round(cashInvestmentReturn),
                    realtyInvestmentReturn: Math.round(realtyInvestmentReturn),
                    totalInvestmentReturn: Math.round(totalInvestmentReturn)
                });

                if (year < horizon) {
                    // Store current values as previous for next iteration
                    prevValues = {
                        stocks: assetValues.stocks,
                        bonds: assetValues.bonds,
                        cash: assetValues.cash,
                        realty: assetValues.realty
                    };

                    // Add annual contributions distributed by allocation
                    const annualContribution = monthlyInvestment * 12;
                    assetValues.stocks += annualContribution * (allocation.stocks / 100);
                    assetValues.bonds += annualContribution * (allocation.bonds / 100);
                    assetValues.cash += annualContribution * (allocation.cash / 100);
                    assetValues.realty += annualContribution * (allocation.realty / 100);

                    // Apply compound interest - return on entire value (initial + contributions + past gains)
                    assetValues.stocks *= (1 + inflation + returns.stocks[scenario] / 100);
                    assetValues.bonds *= (1 + inflation + returns.bonds[scenario] / 100);
                    assetValues.cash *= (1 + inflation + returns.cash[scenario] / 100);
                    assetValues.realty *= (1 + inflation + returns.realty[scenario] / 100);
                }
            }

            return breakdownData;
        }

        // Step 7: Render comparison charts (without and with regular investments)
        function renderComparisonCharts() {
            const scenarios = ['pessimistic', 'base', 'optimistic'];
            const scenarioColors = {
                pessimistic: '#ef4444',
                base: '#3b82f6',
                optimistic: '#10b981'
            };

            // Calculate both scenarios
            const dataWithout = {};
            const dataWith = {};

            scenarios.forEach(scenario => {
                dataWithout[scenario] = calculateProjectionWithoutContributions(scenario);
                dataWith[scenario] = calculateProjectionWithRegularInvestments(scenario);
            });

            // Update benefit summary
            const horizon = appState.planning.horizon;
            const lastYear = horizon;
            const benefitPessimistic = dataWith.pessimistic[lastYear].capital - dataWithout.pessimistic[lastYear].capital;
            const benefitOptimistic = dataWith.optimistic[lastYear].capital - dataWithout.optimistic[lastYear].capital;

            benefitMin.textContent = '+' + formatCurrency(benefitPessimistic);
            benefitMax.textContent = '+' + formatCurrency(benefitOptimistic);

            let yearText = 'лет';
            if (horizon === 1) yearText = 'год';
            else if (horizon >= 2 && horizon <= 4) yearText = 'года';
            benefitHorizon.textContent = `${horizon} ${yearText}`;
        }

        // Step 7: Helper function to render a single comparison chart
        function renderSingleChart(container, scenarioData, scenarioColors) {
            const width = container.clientWidth || 300;
            const height = 350;
            const padding = 40;
            const scenarios = ['pessimistic', 'base', 'optimistic'];

            // Find global min/max
            let allCapitals = [];
            scenarios.forEach(scenario => {
                allCapitals = allCapitals.concat(scenarioData[scenario].map(d => d.capital));
            });
            const maxCapital = Math.max(...allCapitals);
            const minCapital = Math.min(...allCapitals);

            const horizon = appState.planning.horizon;
            const xScale = (year) => padding + (year / horizon) * (width - 2 * padding);
            const yScale = (capital) => height - padding - ((capital - minCapital) / (maxCapital - minCapital)) * (height - 2 * padding);

            // Generate paths
            const paths = scenarios.map(scenario => {
                const data = scenarioData[scenario];
                let pathD = '';
                data.forEach((point, i) => {
                    const x = xScale(point.year);
                    const y = yScale(point.capital);
                    if (i === 0) {
                        pathD += `M ${x} ${y}`;
                    } else {
                        pathD += ` L ${x} ${y}`;
                    }
                });
                return { scenario, pathD, data, color: scenarioColors[scenario] };
            });

            // Format Y axis values
            const formatYAxisValue = (value) => {
                if (value >= 1000000) {
                    return (value / 1000000).toFixed(1) + 'M';
                } else if (value >= 1000) {
                    return (value / 1000).toFixed(0) + 'K';
                }
                return value.toFixed(0);
            };

            let svg = `
                <svg viewBox="0 0 ${width} ${height}" xmlns="http://www.w3.org/2000/svg">
                    <!-- Grid lines -->
                    ${[0, 0.5, 1].map(ratio => {
                        const y = height - padding - ratio * (height - 2 * padding);
                        const value = minCapital + ratio * (maxCapital - minCapital);
                        return `
                            <line x1="${padding}" y1="${y}" x2="${width - padding}" y2="${y}" stroke="#e2e8f0" stroke-width="1"/>
                            <text x="${padding - 5}" y="${y + 4}" text-anchor="end" font-size="10" fill="#999">${formatYAxisValue(value)}</text>
                        `;
                    }).join('')}

                    <!-- X axis labels -->
                    ${scenarioData.base.map(point => {
                        const x = xScale(point.year);
                        return `<text x="${x}" y="${height - padding + 20}" text-anchor="middle" font-size="10" fill="#999">${point.year}г</text>`;
                    }).join('')}

                    <!-- Lines -->
                    ${paths.map(({ pathD, color }) => `
                        <path d="${pathD}" fill="none" stroke="${color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" opacity="0.8"/>
                    `).join('')}

                    <!-- Points -->
                    ${paths.map(({ data, color }) => data.map(point => {
                        const x = xScale(point.year);
                        const y = yScale(point.capital);
                        return `<circle cx="${x}" cy="${y}" r="3" fill="${color}" opacity="0.8"/>`;
                    }).join('')).join('')}
                </svg>
            `;

            container.innerHTML = svg;
        }

        // Step 7: Render breakdown chart (stacked bar chart)
        function renderBreakdownChart(scenario) {
            scenario = scenario || 'base';
            const data = calculateProjectionBreakdown(scenario);
            const width = chartBreakdown.clientWidth || 300;
            const height = 400;
            const padding = 40;
            const horizon = appState.planning.horizon;

            // Find max total
            const maxTotal = Math.max(...data.map(d => d.total));

            const barWidth = (width - 2 * padding) / (horizon + 1) * 0.6;
            const xScale = (year) => padding + (year / horizon) * (width - 2 * padding);
            const yScale = (value) => height - padding - (value / maxTotal) * (height - 2 * padding);

            // Format Y axis values
            const formatYAxisValue = (value) => {
                if (value >= 1000000) {
                    return (value / 1000000).toFixed(1) + 'M';
                } else if (value >= 1000) {
                    return (value / 1000).toFixed(0) + 'K';
                }
                return value.toFixed(0);
            };

            let svg = `
                <svg viewBox="0 0 ${width} ${height}" xmlns="http://www.w3.org/2000/svg">
                    <!-- Grid lines -->
                    ${[0, 0.5, 1].map(ratio => {
                        const y = height - padding - ratio * (height - 2 * padding);
                        const value = ratio * maxTotal;
                        return `
                            <line x1="${padding}" y1="${y}" x2="${width - padding}" y2="${y}" stroke="#e2e8f0" stroke-width="1"/>
                            <text x="${padding - 5}" y="${y + 4}" text-anchor="end" font-size="10" fill="#999">${formatYAxisValue(value)}</text>
                        `;
                    }).join('')}

                    <!-- X axis labels -->
                    ${data.map(point => {
                        const x = xScale(point.year);
                        return `<text x="${x}" y="${height - padding + 20}" text-anchor="middle" font-size="10" fill="#999">${point.year}г</text>`;
                    }).join('')}

                    <!-- Stacked bars -->
                    ${data.map(point => {
                        const x = xScale(point.year) - barWidth / 2;
                        const baseHeight = (point.baseAssets / maxTotal) * (height - 2 * padding);
                        const contributionsHeight = (point.totalContributions / maxTotal) * (height - 2 * padding);
                        const gainsHeight = (point.investmentGains / maxTotal) * (height - 2 * padding);

                        return `
                            <!-- Base assets (green) -->
                            <rect x="${x}" y="${height - padding - baseHeight}" width="${barWidth}" height="${baseHeight}" fill="#10b981" opacity="0.8"/>

                            <!-- Contributions (blue) -->
                            <rect x="${x}" y="${height - padding - baseHeight - contributionsHeight}" width="${barWidth}" height="${contributionsHeight}" fill="#3b82f6" opacity="0.8"/>

                            <!-- Investment gains (amber) -->
                            <rect x="${x}" y="${height - padding - baseHeight - contributionsHeight - gainsHeight}" width="${barWidth}" height="${gainsHeight}" fill="#f59e0b" opacity="0.8"/>
                        `;
                    }).join('')}
                </svg>
            `;

            chartBreakdown.innerHTML = svg;
        }

        // Step 7: Render asset type breakdown table
        function renderAssetTypeTable(scenario) {
            scenario = scenario || 'base';
            const data = calculateAssetTypeBreakdown(scenario);
            const container = document.getElementById('assetTypeTableContainer');

            if (!container) return;

            // Helper function to format contribution value (regular additions)
            const formatContribution = (contribution) => {
                if (contribution === 0) return '-';
                return formatCurrency(contribution);
            };

            // Helper function to format investment return value
            const formatReturn = (returnValue) => {
                if (returnValue === 0) return '-';
                const formatted = formatCurrency(Math.abs(returnValue));
                const sign = returnValue > 0 ? '+' : '-';
                return `<span class="return-cell ${returnValue > 0 ? 'positive' : 'negative'}">${sign}${formatted}</span>`;
            };

            let html = `
                <table class="asset-type-table">
                    <thead>
                        <tr>
                            <th style="text-align: left;" rowspan="2">Год</th>
                            <th colspan="3">Фонды акций</th>
                            <th colspan="3">Фонды облигаций</th>
                            <th colspan="3">Депозиты</th>
                            <th colspan="3">Недвижимость</th>
                            <th colspan="3">Всего</th>
                        </tr>
                        <tr>
                            <th class="subheader">Сумма</th>
                            <th class="subheader">Пополнения</th>
                            <th class="subheader">Доход</th>
                            <th class="subheader">Сумма</th>
                            <th class="subheader">Пополнения</th>
                            <th class="subheader">Доход</th>
                            <th class="subheader">Сумма</th>
                            <th class="subheader">Пополнения</th>
                            <th class="subheader">Доход</th>
                            <th class="subheader">Сумма</th>
                            <th class="subheader">Пополнения</th>
                            <th class="subheader">Доход</th>
                            <th class="subheader">Сумма</th>
                            <th class="subheader">Пополнения</th>
                            <th class="subheader">Доход</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.forEach(row => {
                html += `
                    <tr>
                        <td style="text-align: left; font-weight: 600;">${row.year}</td>
                        <td>${formatCurrency(row.stocks)}</td>
                        <td class="contribution-column">${formatContribution(row.stocksContributions)}</td>
                        <td class="return-column">${formatReturn(row.stocksInvestmentReturn)}</td>
                        <td>${formatCurrency(row.bonds)}</td>
                        <td class="contribution-column">${formatContribution(row.bondsContributions)}</td>
                        <td class="return-column">${formatReturn(row.bondsInvestmentReturn)}</td>
                        <td>${formatCurrency(row.cash)}</td>
                        <td class="contribution-column">${formatContribution(row.cashContributions)}</td>
                        <td class="return-column">${formatReturn(row.cashInvestmentReturn)}</td>
                        <td>${formatCurrency(row.realty)}</td>
                        <td class="contribution-column">${formatContribution(row.realtyContributions)}</td>
                        <td class="return-column">${formatReturn(row.realtyInvestmentReturn)}</td>
                        <td style="font-weight: 600;">${formatCurrency(row.total)}</td>
                        <td class="contribution-column" style="font-weight: 600;">${formatContribution(row.totalContributions)}</td>
                        <td class="return-column" style="font-weight: 600;">${formatReturn(row.totalInvestmentReturn)}</td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            container.innerHTML = html;
        }

        // Step 7: Render combined chart (both lines on one chart for selected scenario)
        function renderCombinedChart(scenario) {
            const scenarioColors = {
                pessimistic: '#ef4444',
                base: '#3b82f6',
                optimistic: '#10b981'
            };

            const color = scenarioColors[scenario];

            // Get data for both cases (with and without)
            const dataWithout = calculateProjectionWithoutContributions(scenario);
            const dataWith = calculateProjectionWithRegularInvestments(scenario);

            const width = chartCombined.clientWidth || 300;
            const height = 350;
            const padding = 40;

            // Find global min/max across both datasets
            const allCapitals = [...dataWithout.map(d => d.capital), ...dataWith.map(d => d.capital)];
            const maxCapital = Math.max(...allCapitals);
            const minCapital = Math.min(...allCapitals);

            const horizon = appState.planning.horizon;
            const xScale = (year) => padding + (year / horizon) * (width - 2 * padding);
            const yScale = (capital) => height - padding - ((capital - minCapital) / (maxCapital - minCapital)) * (height - 2 * padding);

            // Generate path for "without" (dashed)
            let pathWithout = '';
            dataWithout.forEach((point, i) => {
                const x = xScale(point.year);
                const y = yScale(point.capital);
                if (i === 0) {
                    pathWithout += `M ${x} ${y}`;
                } else {
                    pathWithout += ` L ${x} ${y}`;
                }
            });

            // Generate path for "with" (solid)
            let pathWith = '';
            dataWith.forEach((point, i) => {
                const x = xScale(point.year);
                const y = yScale(point.capital);
                if (i === 0) {
                    pathWith += `M ${x} ${y}`;
                } else {
                    pathWith += ` L ${x} ${y}`;
                }
            });

            // Format Y axis values
            const formatYAxisValue = (value) => {
                if (value >= 1000000) {
                    return (value / 1000000).toFixed(1) + 'M';
                } else if (value >= 1000) {
                    return (value / 1000).toFixed(0) + 'K';
                }
                return value.toFixed(0);
            };

            let svg = `
                <svg viewBox="0 0 ${width} ${height}" xmlns="http://www.w3.org/2000/svg">
                    <!-- Grid lines -->
                    ${[0, 0.5, 1].map(ratio => {
                        const y = height - padding - ratio * (height - 2 * padding);
                        const value = minCapital + ratio * (maxCapital - minCapital);
                        return `
                            <line x1="${padding}" y1="${y}" x2="${width - padding}" y2="${y}" stroke="#e2e8f0" stroke-width="1"/>
                            <text x="${padding - 5}" y="${y + 4}" text-anchor="end" font-size="10" fill="#999">${formatYAxisValue(value)}</text>
                        `;
                    }).join('')}

                    <!-- X axis labels -->
                    ${dataWithout.map(point => {
                        const x = xScale(point.year);
                        return `<text x="${x}" y="${height - padding + 20}" text-anchor="middle" font-size="10" fill="#999">${point.year}г</text>`;
                    }).join('')}

                    <!-- Line WITHOUT (dashed) -->
                    <path d="${pathWithout}" fill="none" stroke="${color}" stroke-width="2" stroke-dasharray="5,5" opacity="0.6"/>

                    <!-- Line WITH (solid) -->
                    <path d="${pathWith}" fill="none" stroke="${color}" stroke-width="2" opacity="0.9"/>

                    <!-- Points WITHOUT -->
                    ${dataWithout.map(point => {
                        const x = xScale(point.year);
                        const y = yScale(point.capital);
                        return `<circle cx="${x}" cy="${y}" r="3" fill="${color}" opacity="0.6"/>`;
                    }).join('')}

                    <!-- Points WITH -->
                    ${dataWith.map(point => {
                        const x = xScale(point.year);
                        const y = yScale(point.capital);
                        return `<circle cx="${x}" cy="${y}" r="3" fill="${color}" opacity="0.9"/>`;
                    }).join('')}
                </svg>
            `;

            chartCombined.innerHTML = svg;
        }

        // Navigate to step
        function goToStep(step) {
            appState.currentStep = step;

            // Update steps visibility
            steps.forEach((el, index) => {
                el.classList.toggle('active', index + 1 === step);
            });

            // Update progress bar
            progressSteps.forEach((el, index) => {
                el.classList.remove('active', 'completed');
                if (index + 1 < step) {
                    el.classList.add('completed');
                } else if (index + 1 === step) {
                    el.classList.add('active');
                }
            });

            // Update buttons
            btnPrev.classList.toggle('hidden', step === 1);

            if (step === 1) {
                btnNext.disabled = !validateStep1();
            } else if (step === 2) {
                btnNext.disabled = !validateStep2();
            } else if (step === 3) {
                btnNext.disabled = !validateStep3();
            } else if (step === 4) {
                btnNext.disabled = !validateStep4();
            } else if (step === 5) {
                btnNext.disabled = !validateStep5();
            } else if (step === 6) {
                btnNext.disabled = !validateStep6();
                btnNext.textContent = 'Готово ✓';
            } else if (step === 7) {
                btnNext.disabled = false;
                btnNext.textContent = '🔄 Начать сначала';
            } else {
                btnNext.disabled = false;
            }

            // Reset button text for non-final steps
            if (step < 6) {
                btnNext.textContent = 'Далее →';
            }

            // Scroll to top
            window.scrollTo(0, 0);

            // If step 5, render chart and update horizon text
            if (step === 5) {
                let yearText = 'лет';
                const years = appState.planning.horizon;
                if (years === 1) yearText = 'год';
                else if (years >= 2 && years <= 4) yearText = 'года';
                resultsHorizon.textContent = `${years} ${yearText}`;

                renderChart();
            }

            // If step 6, update profile summary, apply recommended allocation, and update amounts
            if (step === 6) {
                updateProfileSummary();
                applyRecommendedAllocation();
                updateAssetReturns();
                const savings = appState.profile.monthlyIncome - appState.profile.monthlyExpenses;
                monthlySavingsReminder.textContent = formatCurrency(savings);
                updateInvestmentAmounts();
                checkAllocationBounds();
            }

            // If step 7, render comparison charts and breakdown
            if (step === 7) {
                renderComparisonCharts();
                renderBreakdownChart('base');
                renderCombinedChart('base');
                renderAssetTypeTable('base');
            }

            saveData();
        }

        // Add asset
        function addAsset() {
            if (!appState.selectedAssetType) return;

            const amount = parseFloat(parseNumberWithSpaces(assetAmountInput.value));
            if (!amount || amount <= 0) return;

            const asset = {
                id: Date.now(),
                type: appState.selectedAssetType,
                amount: amount,
                ...assetInfo[appState.selectedAssetType]
            };

            appState.assets.push(asset);

            // Reset form
            assetAmountInput.value = '';
            appState.selectedAssetType = null;
            assetCategories.forEach(cat => cat.classList.remove('selected'));
            btnAddAsset.disabled = true;

            renderAssets();
            saveData();
        }

        // Delete asset
        function deleteAsset(id) {
            appState.assets = appState.assets.filter(a => a.id !== id);
            renderAssets();
            saveData();
        }

        // Render assets
        function renderAssets() {
            if (appState.assets.length === 0) {
                assetList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">💼</div>
                        <div>Добавьте активы для расчета прогноза</div>
                    </div>
                `;
                totalCard.classList.add('hidden');
                return;
            }

            const total = appState.assets.reduce((sum, a) => sum + a.amount, 0);

            assetList.innerHTML = appState.assets.map(asset => `
                <div class="asset-item">
                    <div class="asset-item-info">
                        <div class="asset-item-icon">${asset.icon}</div>
                        <div class="asset-item-details">
                            <div class="asset-item-name">${asset.name}</div>
                            <div class="asset-item-category">${formatCurrency(asset.amount)}</div>
                        </div>
                    </div>
                    <button class="btn-delete" onclick="deleteAsset(${asset.id})">×</button>
                </div>
            `).join('');

            totalValue.textContent = formatCurrency(total);
            totalCard.classList.remove('hidden');
        }

        // Add liability
        function addLiability() {
            const name = liabilityNameInput.value.trim();
            const balance = parseFloat(parseNumberWithSpaces(liabilityBalanceInput.value));
            const payment = parseFloat(parseNumberWithSpaces(liabilityPaymentInput.value));
            const rate = parseFloat(parseNumberWithSpaces(liabilityRateInput.value));
            const term = parseFloat(parseNumberWithSpaces(liabilityTermInput.value));

            if (!name || !balance || balance <= 0 || !payment || payment <= 0 || !rate || rate < 0 || !term || term <= 0) {
                return;
            }

            const liability = {
                id: Date.now(),
                name,
                balance,
                payment,
                rate,
                term
            };

            appState.liabilities.push(liability);

            // Reset form
            liabilityNameInput.value = '';
            liabilityBalanceInput.value = '';
            liabilityPaymentInput.value = '';
            liabilityRateInput.value = '';
            liabilityTermInput.value = '';
            btnAddLiability.disabled = true;

            renderLiabilities();
            saveData();
        }

        // Delete liability
        function deleteLiability(id) {
            appState.liabilities = appState.liabilities.filter(l => l.id !== id);
            renderLiabilities();
            saveData();
        }

        // Render liabilities
        function renderLiabilities() {
            if (appState.liabilities.length === 0) {
                liabilitiesList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">📋</div>
                        <div>Нет обязательств - это здорово!</div>
                    </div>
                `;
                totalLiabilitiesCard.classList.add('hidden');
                return;
            }

            const total = appState.liabilities.reduce((sum, l) => sum + l.balance, 0);

            liabilitiesList.innerHTML = appState.liabilities.map(liability => `
                <div class="asset-item">
                    <div class="asset-item-info">
                        <div class="asset-item-icon">💳</div>
                        <div class="asset-item-details">
                            <div class="asset-item-name">${liability.name}</div>
                            <div class="asset-item-category">${formatCurrency(liability.balance)} • ${formatCurrency(liability.payment)}/мес • ${liability.rate}%</div>
                        </div>
                    </div>
                    <button class="btn-delete" onclick="deleteLiability(${liability.id})">×</button>
                </div>
            `).join('');

            totalLiabilitiesValue.textContent = formatCurrency(total);
            totalLiabilitiesCard.classList.remove('hidden');
        }

        // Track which field was edited last
        let lastEditedField = null;

        // Calculate liability payment from rate
        function calculateLiabilityPayment() {
            const balance = parseFloat(parseNumberWithSpaces(liabilityBalanceInput.value));
            const rate = parseFloat(parseNumberWithSpaces(liabilityRateInput.value));
            const term = parseFloat(parseNumberWithSpaces(liabilityTermInput.value));

            if (balance > 0 && rate >= 0 && term > 0) {
                const monthlyRate = rate / 100 / 12;
                let payment;
                if (monthlyRate === 0) {
                    payment = balance / term;
                } else {
                    payment = balance * (monthlyRate * Math.pow(1 + monthlyRate, term)) / (Math.pow(1 + monthlyRate, term) - 1);
                }
                liabilityPaymentInput.value = formatNumberWithSpaces(Math.round(payment));
            } else if (!liabilityPaymentInput.value) {
                liabilityPaymentInput.value = '';
            }
            validateLiabilityForm();
        }

        // Calculate liability rate from payment (using Newton's method)
        function calculateLiabilityRate() {
            const balance = parseFloat(parseNumberWithSpaces(liabilityBalanceInput.value));
            const payment = parseFloat(parseNumberWithSpaces(liabilityPaymentInput.value));
            const term = parseFloat(parseNumberWithSpaces(liabilityTermInput.value));

            if (balance > 0 && payment > 0 && term > 0) {
                // Check if payment is sufficient
                if (payment < balance / term) {
                    liabilityRateInput.value = '';
                    validateLiabilityForm();
                    return;
                }

                // Newton's method to find interest rate
                let rate = 0.1; // Initial guess 10%
                const tolerance = 0.0001;
                const maxIterations = 100;

                for (let i = 0; i < maxIterations; i++) {
                    const monthlyRate = rate / 12;
                    const pow = Math.pow(1 + monthlyRate, term);
                    const calculatedPayment = balance * (monthlyRate * pow) / (pow - 1);

                    if (Math.abs(calculatedPayment - payment) < tolerance) {
                        liabilityRateInput.value = (rate * 100).toFixed(2);
                        break;
                    }

                    // Derivative for Newton's method
                    const derivative = balance * term * Math.pow(1 + monthlyRate, term - 1) / (12 * Math.pow(Math.pow(1 + monthlyRate, term) - 1, 2));
                    rate = rate - (calculatedPayment - payment) / derivative;

                    if (rate < 0) rate = 0;
                    if (rate > 1) rate = 1;
                }
            } else if (!liabilityRateInput.value) {
                liabilityRateInput.value = '';
            }
            validateLiabilityForm();
        }

        // Validate liability form
        function validateLiabilityForm() {
            const name = liabilityNameInput.value.trim();
            const balance = parseFloat(parseNumberWithSpaces(liabilityBalanceInput.value));
            const payment = parseFloat(parseNumberWithSpaces(liabilityPaymentInput.value));
            const rate = parseFloat(parseNumberWithSpaces(liabilityRateInput.value));
            const term = parseFloat(parseNumberWithSpaces(liabilityTermInput.value));

            const isValid = name && balance > 0 && payment > 0 && rate >= 0 && term > 0;
            btnAddLiability.disabled = !isValid;
        }

        // Save to localStorage
        function saveData() {
            localStorage.setItem('fintest_data', JSON.stringify(appState));
        }

        // Load from localStorage
        function loadData() {
            const saved = localStorage.getItem('fintest_data');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    Object.assign(appState, data);

                    // Restore Step 1
                    if (appState.profile.age) ageInput.value = appState.profile.age;
                    incomeSlider.value = appState.profile.monthlyIncome;
                    expensesSlider.value = appState.profile.monthlyExpenses;
                    incomeValue.textContent = formatCurrency(appState.profile.monthlyIncome);
                    expensesValue.textContent = formatCurrency(appState.profile.monthlyExpenses);
                    updateSliderBackground(incomeSlider);
                    updateSliderBackground(expensesSlider);
                    updateSavings();

                    // Restore Step 2
                    renderAssets();

                    // Restore Step 3
                    renderLiabilities();

                    // Restore Step 4
                    if (appState.planning) {
                        horizonSlider.value = appState.planning.horizon || 5;
                        updateHorizon();
                        updateSliderBackground(horizonSlider);

                        if (appState.planning.riskProfile) {
                            riskProfiles.forEach(p => {
                                if (p.dataset.risk === appState.planning.riskProfile) {
                                    p.classList.add('selected');
                                }
                            });
                        }

                        if (appState.planning.inflation) {
                            inflationRateInput.value = appState.planning.inflation;
                        }
                    }

                    // Go to saved step
                    goToStep(appState.currentStep);
                } catch (e) {
                    console.error('Error loading data:', e);
                }
            }
        }

        // Event Listeners - Step 1
        ageInput.addEventListener('input', () => {
            formatInputOnType(ageInput, false);
            const age = parseInt(parseNumberWithSpaces(ageInput.value));
            if (age) appState.profile.age = age;
            validateStep1();
            btnNext.disabled = !validateStep1();
            saveData();
        });

        ageInput.addEventListener('change', () => {
            validateStep1();
            btnNext.disabled = !validateStep1();
            saveData();
        });


        incomeSlider.addEventListener('input', () => {
            appState.profile.monthlyIncome = parseInt(incomeSlider.value);
            incomeValue.textContent = formatCurrency(appState.profile.monthlyIncome);
            updateSliderBackground(incomeSlider);
            updateSavings();
            saveData();
        });

        expensesSlider.addEventListener('input', () => {
            appState.profile.monthlyExpenses = parseInt(expensesSlider.value);
            expensesValue.textContent = formatCurrency(appState.profile.monthlyExpenses);
            updateSliderBackground(expensesSlider);
            updateSavings();
            saveData();
        });

        // Event Listeners - Step 2
        assetCategories.forEach(category => {
            category.addEventListener('click', () => {
                assetCategories.forEach(c => c.classList.remove('selected'));
                category.classList.add('selected');
                appState.selectedAssetType = category.dataset.type;

                const amount = parseFloat(assetAmountInput.value);
                btnAddAsset.disabled = !amount || amount <= 0;
            });
        });

        assetAmountInput.addEventListener('input', () => {
            formatInputOnType(assetAmountInput, false);
            const amount = parseFloat(parseNumberWithSpaces(assetAmountInput.value));
            btnAddAsset.disabled = !appState.selectedAssetType || !amount || amount <= 0;
        });


        btnAddAsset.addEventListener('click', addAsset);

        // Event Listeners - Step 3
        liabilityNameInput.addEventListener('input', validateLiabilityForm);

        liabilityBalanceInput.addEventListener('input', () => {
            formatInputOnType(liabilityBalanceInput, false);
            if (lastEditedField === 'payment') {
                calculateLiabilityRate();
            } else {
                calculateLiabilityPayment();
            }
        });
        liabilityRateInput.addEventListener('input', () => {
            formatInputOnType(liabilityRateInput, true);
            lastEditedField = 'rate';
            calculateLiabilityPayment();
        });

        liabilityTermInput.addEventListener('input', () => {
            formatInputOnType(liabilityTermInput, false);
            if (lastEditedField === 'payment') {
                calculateLiabilityRate();
            } else {
                calculateLiabilityPayment();
            }
        });

        liabilityPaymentInput.addEventListener('input', () => {
            formatInputOnType(liabilityPaymentInput, false);
            lastEditedField = 'payment';
            calculateLiabilityRate();
        });

        btnAddLiability.addEventListener('click', addLiability);

        // Event Listeners - Step 4
        horizonSlider.addEventListener('input', () => {
            updateHorizon();
            updateSliderBackground(horizonSlider);
            saveData();
        });

        riskProfiles.forEach(profile => {
            profile.addEventListener('click', () => {
                riskProfiles.forEach(p => p.classList.remove('selected'));
                profile.classList.add('selected');
                appState.planning.riskProfile = profile.dataset.risk;

                if (appState.currentStep === 4) {
                    btnNext.disabled = !validateStep4();
                }
                saveData();
            });
        });

        inflationRateInput.addEventListener('input', () => {
            formatInputOnType(inflationRateInput, true);
            const inflation = parseFloat(parseNumberWithSpaces(inflationRateInput.value));
            if (inflation) appState.planning.inflation = inflation;

            if (appState.currentStep === 4) {
                btnNext.disabled = !validateStep4();
            }
            saveData();
        });

        // Show scenario info modal
        function showScenarioInfo() {
            const inflation = appState.planning.inflation;
            const scenarios = [
                {
                    name: 'Пессимистичный',
                    color: '#ef4444',
                    data: [
                        { asset: 'Фонды акций', delta: -4, total: inflation - 4 },
                        { asset: 'Фонды облигаций', delta: -2, total: inflation - 2 },
                        { asset: 'Депозиты', delta: -2, total: inflation - 2 },
                        { asset: 'Недвижимость', delta: 0, total: inflation }
                    ]
                },
                {
                    name: 'Базовый',
                    color: '#3b82f6',
                    data: [
                        { asset: 'Фонды акций', delta: 5, total: inflation + 5 },
                        { asset: 'Фонды облигаций', delta: 1, total: inflation + 1 },
                        { asset: 'Депозиты', delta: -1, total: inflation - 1 },
                        { asset: 'Недвижимость', delta: 1, total: inflation + 1 }
                    ]
                },
                {
                    name: 'Оптимистичный',
                    color: '#10b981',
                    data: [
                        { asset: 'Фонды акций', delta: 10, total: inflation + 10 },
                        { asset: 'Фонды облигаций', delta: 5, total: inflation + 5 },
                        { asset: 'Депозиты', delta: 0, total: inflation },
                        { asset: 'Недвижимость', delta: 2, total: inflation + 2 }
                    ]
                }
            ];

            const html = scenarios.map(scenario => `
                <div class="scenario-info-item">
                    <div class="scenario-info-title">
                        <div class="legend-color" style="background: ${scenario.color};"></div>
                        <span>${scenario.name} сценарий</span>
                    </div>
                    <p style="font-size: 0.85rem; color: var(--tg-theme-hint-color); margin-bottom: 0.75rem;">
                        Доходность = инфляция (${inflation}%) + параметр:
                    </p>
                    <table class="scenario-info-table">
                        ${scenario.data.map(item => `
                            <tr>
                                <td>${item.asset}</td>
                                <td>${inflation}% ${item.delta >= 0 ? '+' : ''}${item.delta}% = ${item.total}%</td>
                            </tr>
                        `).join('')}
                    </table>
                </div>
            `).join('');

            modalBody.innerHTML = html;
            scenarioModal.classList.add('active');
        }

        // Event Listeners - Step 5
        inflationToggle.addEventListener('change', () => {
            if (appState.currentStep === 5) {
                renderChart();
            }
        });

        btnScenarioInfo.addEventListener('click', showScenarioInfo);

        modalClose.addEventListener('click', () => {
            scenarioModal.classList.remove('active');
        });

        scenarioModal.addEventListener('click', (e) => {
            if (e.target === scenarioModal) {
                scenarioModal.classList.remove('active');
            }
        });

        // Navigation
        btnNext.addEventListener('click', () => {
            if (appState.currentStep === 1) {
                if (validateStep1()) {
                    goToStep(2);
                }
            } else if (appState.currentStep === 2) {
                if (validateStep2()) {
                    goToStep(3);
                }
            } else if (appState.currentStep === 3) {
                if (validateStep3()) {
                    goToStep(4);
                }
            } else if (appState.currentStep === 4) {
                if (validateStep4()) {
                    goToStep(5);
                }
            } else if (appState.currentStep === 5) {
                if (validateStep5()) {
                    goToStep(6);
                }
            } else if (appState.currentStep === 6) {
                if (validateStep6()) {
                    goToStep(7);
                }
            } else if (appState.currentStep === 7) {
                // Reset and start over
                if (tg) {
                    tg.showConfirm('Начать новый расчет?', (confirmed) => {
                        if (confirmed) {
                            location.reload();
                        }
                    });
                } else {
                    if (confirm('Начать новый расчет?')) {
                        location.reload();
                    }
                }
            }
        });

        btnPrev.addEventListener('click', () => {
            if (appState.currentStep > 1) {
                goToStep(appState.currentStep - 1);
            }
        });

        // Make functions available globally
        window.deleteAsset = deleteAsset;
        window.deleteLiability = deleteLiability;

        // Step 6: Get recommended allocation based on horizon and risk profile
        function getRecommendedAllocation() {
            const horizon = appState.planning.horizon;
            const riskProfile = appState.planning.riskProfile;

            // Determine horizon range
            let horizonKey;
            if (horizon <= 4) {
                horizonKey = '3-4';
            } else if (horizon >= 5 && horizon <= 9) {
                horizonKey = '5-9';
            } else {
                horizonKey = '10+';
            }

            return RECOMMENDED_ALLOCATIONS[horizonKey][riskProfile];
        }

        // Step 6: Apply recommended allocation to sliders
        function applyRecommendedAllocation() {
            const recommended = getRecommendedAllocation();

            // Set allocation values in appState
            appState.regularInvestments.allocation.stocks = recommended.stocks;
            appState.regularInvestments.allocation.bonds = recommended.bonds;
            appState.regularInvestments.allocation.cash = recommended.cash;
            appState.regularInvestments.allocation.realty = recommended.realty;

            // Update sliders
            stocksAllocation.value = recommended.stocks;
            bondsAllocation.value = recommended.bonds;
            cashAllocation.value = recommended.cash;
            realtyAllocation.value = recommended.realty;

            // Update displayed values
            stocksAllocationValue.textContent = recommended.stocks + '%';
            bondsAllocationValue.textContent = recommended.bonds + '%';
            cashAllocationValue.textContent = recommended.cash + '%';
            realtyAllocationValue.textContent = recommended.realty + '%';

            // Update slider backgrounds
            updateSliderBackground(stocksAllocation);
            updateSliderBackground(bondsAllocation);
            updateSliderBackground(cashAllocation);

            // Set min/max bounds (±20% from recommended)
            stocksAllocation.min = Math.max(0, recommended.stocks - 20);
            stocksAllocation.max = Math.min(100, recommended.stocks + 20);
            bondsAllocation.min = Math.max(0, recommended.bonds - 20);
            bondsAllocation.max = Math.min(100, recommended.bonds + 20);
            cashAllocation.min = Math.max(0, recommended.cash - 20);
            cashAllocation.max = Math.min(100, recommended.cash + 20);

            // Update recommended text
            stocksRecommended.textContent = `рекомендовано ${recommended.stocks}%`;
            bondsRecommended.textContent = `рекомендовано ${recommended.bonds}%`;
            cashRecommended.textContent = `рекомендовано ${recommended.cash}%`;
        }

        // Step 6: Auto-balance sliders when one changes
        function autoBalanceSliders(changedAsset, newValue) {
            const recommended = getRecommendedAllocation();
            const oldValue = appState.regularInvestments.allocation[changedAsset];
            const delta = newValue - oldValue;

            // Update the changed asset
            appState.regularInvestments.allocation[changedAsset] = newValue;

            // If delta is 0, nothing to balance
            if (delta === 0) {
                checkAllocationBounds();
                updateAllocationTotal();
                return;
            }

            // Get other active assets (not realty, not the changed one)
            const otherAssets = ['stocks', 'bonds', 'cash'].filter(a => a !== changedAsset);

            // Calculate total of other assets
            let otherTotal = 0;
            otherAssets.forEach(asset => {
                otherTotal += appState.regularInvestments.allocation[asset];
            });

            // If otherTotal is 0, distribute evenly
            if (otherTotal === 0) {
                const perAsset = Math.round(-delta / otherAssets.length);
                otherAssets.forEach((asset, index) => {
                    // Last asset gets the remainder to ensure sum = 100
                    const adjustment = (index === otherAssets.length - 1)
                        ? (100 - newValue - perAsset * (otherAssets.length - 1))
                        : perAsset;
                    appState.regularInvestments.allocation[asset] = Math.max(0, Math.min(100, adjustment));
                });
            } else {
                // Distribute delta proportionally
                let totalAdjusted = newValue;
                otherAssets.forEach((asset, index) => {
                    if (index === otherAssets.length - 1) {
                        // Last asset gets the remainder to ensure sum = 100
                        appState.regularInvestments.allocation[asset] = 100 - totalAdjusted;
                    } else {
                        const proportion = appState.regularInvestments.allocation[asset] / otherTotal;
                        const change = -delta * proportion;
                        let newVal = Math.round(appState.regularInvestments.allocation[asset] + change);

                        // Ensure within bounds
                        const min = Math.max(0, recommended[asset] - 20);
                        const max = Math.min(100, recommended[asset] + 20);
                        newVal = Math.max(min, Math.min(max, newVal));

                        appState.regularInvestments.allocation[asset] = newVal;
                        totalAdjusted += newVal;
                    }
                });
            }

            // Update sliders and values
            stocksAllocation.value = appState.regularInvestments.allocation.stocks;
            bondsAllocation.value = appState.regularInvestments.allocation.bonds;
            cashAllocation.value = appState.regularInvestments.allocation.cash;

            stocksAllocationValue.textContent = appState.regularInvestments.allocation.stocks + '%';
            bondsAllocationValue.textContent = appState.regularInvestments.allocation.bonds + '%';
            cashAllocationValue.textContent = appState.regularInvestments.allocation.cash + '%';

            updateSliderBackground(stocksAllocation);
            updateSliderBackground(bondsAllocation);
            updateSliderBackground(cashAllocation);

            // Check bounds and update total
            checkAllocationBounds();
            updateAllocationTotal();
        }

        // Step 6: Check if allocation is within ±20% bounds
        function checkAllocationBounds() {
            const recommended = getRecommendedAllocation();
            const assets = ['stocks', 'bonds', 'cash'];
            const warnings = {
                stocks: stocksWarning,
                bonds: bondsWarning,
                cash: cashWarning
            };

            assets.forEach(asset => {
                const current = appState.regularInvestments.allocation[asset];
                const rec = recommended[asset];
                const min = Math.max(0, rec - 20);
                const max = Math.min(100, rec + 20);
                const warningEl = warnings[asset];

                if (current < min || current > max) {
                    warningEl.textContent = `⚠️ Отклонение от рекомендации (допустимо ${min}%-${max}%)`;
                    warningEl.classList.remove('hidden');
                } else {
                    warningEl.classList.add('hidden');
                }
            });
        }

        // Step 6: Update profile summary display
        function updateProfileSummary() {
            const horizon = appState.planning.horizon;
            let yearText = 'лет';
            if (horizon === 1) yearText = 'год';
            else if (horizon >= 2 && horizon <= 4) yearText = 'года';

            profileHorizon.textContent = `${horizon} ${yearText}`;

            const riskProfile = appState.planning.riskProfile;
            const riskInfo = riskProfileInfo[riskProfile];
            profileRisk.textContent = `${riskInfo.icon} ${riskInfo.name}`;
        }

        // Step 6: Update expected returns display for each asset
        function updateAssetReturns() {
            const inflation = appState.planning.inflation;
            const assets = ['stocks', 'bonds', 'cash'];
            const assetElements = {
                stocks: document.getElementById('stocksReturns'),
                bonds: document.getElementById('bondsReturns'),
                cash: document.getElementById('cashReturns')
            };

            assets.forEach(asset => {
                const deltas = ASSET_RETURN_DELTAS[asset];
                const el = assetElements[asset];

                const scenarios = [
                    {
                        name: 'Пессимистичный',
                        className: 'pessimistic',
                        delta: deltas.pessimistic
                    },
                    {
                        name: 'Базовый',
                        className: 'base',
                        delta: deltas.base
                    },
                    {
                        name: 'Оптимистичный',
                        className: 'optimistic',
                        delta: deltas.optimistic
                    }
                ];

                let html = '<div class="allocation-returns-title">Ожидаемая среднегодовая доходность:</div>';

                scenarios.forEach(scenario => {
                    const totalReturn = inflation + scenario.delta;
                    const sign = scenario.delta >= 0 ? '+' : '';
                    html += `
                        <div class="allocation-return-row">
                            <span class="allocation-return-scenario ${scenario.className}">${scenario.name}</span>
                            <span class="allocation-return-formula">${inflation}% ${sign}${scenario.delta}% = ${totalReturn}%</span>
                        </div>
                    `;
                });

                el.innerHTML = html;
            });
        }

        // Step 6: Toggle asset returns visibility
        function toggleAssetReturns(asset) {
            const returnsEl = document.getElementById(asset + 'Returns');
            const iconEl = document.getElementById(asset + 'ToggleIcon');

            returnsEl.classList.toggle('hidden');
            iconEl.classList.toggle('expanded');
        }

        // Step 6: Update investment amounts
        function updateInvestmentAmounts() {
            const savings = appState.profile.monthlyIncome - appState.profile.monthlyExpenses;
            const investmentPercent = appState.regularInvestments.investmentPercent;
            const monthlyAmount = Math.round(savings * investmentPercent / 100);
            const annualAmount = monthlyAmount * 12;

            monthlyInvestmentAmount.textContent = formatCurrency(monthlyAmount);
            annualInvestmentAmount.textContent = formatCurrency(annualAmount);
        }

        // Step 6: Update allocation total
        function updateAllocationTotal() {
            const total = appState.regularInvestments.allocation.stocks +
                         appState.regularInvestments.allocation.bonds +
                         appState.regularInvestments.allocation.cash +
                         appState.regularInvestments.allocation.realty;

            totalAllocation.textContent = total + '%';

            // Update visual feedback
            totalAllocation.classList.remove('valid', 'invalid');
            allocationHint.classList.remove('success', 'error');

            if (total === 100) {
                totalAllocation.classList.add('valid');
                allocationHint.classList.add('success');
                allocationHint.textContent = '✓ Распределение корректное';
            } else if (total > 100) {
                totalAllocation.classList.add('invalid');
                allocationHint.classList.add('error');
                allocationHint.textContent = `Превышение на ${total - 100}%`;
            } else {
                totalAllocation.classList.add('invalid');
                allocationHint.classList.add('error');
                allocationHint.textContent = `Осталось распределить ${100 - total}%`;
            }

            // Update button state
            if (appState.currentStep === 6) {
                btnNext.disabled = !validateStep6();
            }

            saveData();
        }

        // Step 6: Investment percent slider
        investmentPercentSlider.addEventListener('input', () => {
            appState.regularInvestments.investmentPercent = parseInt(investmentPercentSlider.value);
            investmentPercentValue.textContent = investmentPercentSlider.value + '%';
            updateSliderBackground(investmentPercentSlider);
            updateInvestmentAmounts();
        });

        // Step 6: Allocation sliders (with auto-balance)
        stocksAllocation.addEventListener('input', () => {
            const newValue = parseInt(stocksAllocation.value);
            stocksAllocationValue.textContent = newValue + '%';
            updateSliderBackground(stocksAllocation);
            autoBalanceSliders('stocks', newValue);
        });

        bondsAllocation.addEventListener('input', () => {
            const newValue = parseInt(bondsAllocation.value);
            bondsAllocationValue.textContent = newValue + '%';
            updateSliderBackground(bondsAllocation);
            autoBalanceSliders('bonds', newValue);
        });

        cashAllocation.addEventListener('input', () => {
            const newValue = parseInt(cashAllocation.value);
            cashAllocationValue.textContent = newValue + '%';
            updateSliderBackground(cashAllocation);
            autoBalanceSliders('cash', newValue);
        });

        // Step 7: Scenario switcher buttons
        scenarioBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                // Remove active class from all buttons
                scenarioBtns.forEach(b => b.classList.remove('active'));
                // Add active class to clicked button
                btn.classList.add('active');
                // Render chart with selected scenario
                const scenario = btn.dataset.scenario;
                renderCombinedChart(scenario);
            });
        });

        // Event listeners for breakdown chart scenario buttons
        scenarioBtnsBreakdown.forEach(btn => {
            btn.addEventListener('click', () => {
                // Remove active class from all buttons
                scenarioBtnsBreakdown.forEach(b => b.classList.remove('active'));
                // Add active class to clicked button
                btn.classList.add('active');
                // Render breakdown chart and table with selected scenario
                const scenario = btn.dataset.scenario;
                renderBreakdownChart(scenario);
                renderAssetTypeTable(scenario);
            });
        });

        // Initialize
        loadData();
        updateSliderBackground(incomeSlider);
        updateSliderBackground(expensesSlider);
        updateSliderBackground(horizonSlider);
        updateSavings();
        updateHorizon();

        // Initialize Step 6 sliders
        updateSliderBackground(investmentPercentSlider);
        updateSliderBackground(stocksAllocation);
        updateSliderBackground(bondsAllocation);
        updateSliderBackground(cashAllocation);
        updateSliderBackground(realtyAllocation);
        updateAllocationTotal();

        // Initialize button states
        btnAddAsset.disabled = true;
        btnAddLiability.disabled = true;

        // Set default inflation if empty
        if (!inflationRateInput.value) {
            inflationRateInput.value = '11';
        }

        console.log('FinTest initialized');
    </script>
</body>
</html>
